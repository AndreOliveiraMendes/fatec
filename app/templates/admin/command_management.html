{% extends "base-fixed" %}
{% block title %}
    Execu√ß√£o de Comandos
{% endblock title %}
{% block content %}
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">
                <span class="glyphicon glyphicon-console"></span> Execu√ß√£o de Comandos SSH
            </h3>
        </div>
        <div class="panel-body">
            <!-- Abas -->
            <ul class="nav nav-tabs" role="tablist">
                <li class="active">
                    <a href="#tab-free" role="tab" data-toggle="tab">Execu√ß√£o Livre</a>
                </li>
                <li>
                    <a href="#tab-templates" role="tab" data-toggle="tab">Comandos Parametrizados</a>
                </li>
            </ul>
            <!-- Conte√∫do das Abas -->
            <div class="tab-content margin-top-15">
                <!-- ===================== ABA 1: EXECU√á√ÉO LIVRE ===================== -->
                <div class="tab-pane fade in active" id="tab-free">
                    <form id="formFreeCommand" class="form-inline margin-bottom-10">
                        <div class="form-group">
                            <label for="credSelect">Credencial:</label>
                            <select id="credSelect" class="form-control" required></select>
                        </div>
                        <div class="form-group wp60">
                            <label for="commandInput" class="sr-only">Comando</label>
                            <input type="text"
                                   id="commandInput"
                                   class="form-control full"
                                   placeholder="Digite um comando SSH..."
                                   required>
                        </div>
                        <button type="submit" class="btn btn-primary">
                            <span class="glyphicon glyphicon-play"></span> Executar
                        </button>
                    </form>
                    <div id="commandHistory">
                        <h4>Hist√≥rico</h4>
                        <div class="clearfix margin-bottom-5">
                            <button id="clearHistoryBtn"
                                    type="button"
                                    class="btn btn-xs btn-default pull-right">üßº Limpar hist√≥rico</button>
                        </div>
                        <ul class="list-group" id="historyList">
                        </ul>
                    </div>
                </div>
                <!-- ===================== ABA 2: COMANDOS PARAMETRIZADOS ===================== -->
                <div class="tab-pane fade" id="tab-templates">
                    <p>üõ†Ô∏è Em breve: aqui voc√™ poder√° configurar comandos com par√¢metros, salvar e reaproveitar.</p>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block extra_script %}
    <script>
        (function() {
            const credSelect = document.getElementById('credSelect');
            const formFree = document.getElementById('formFreeCommand');
            const commandInput = document.getElementById('commandInput');
            const historyList = document.getElementById('historyList');

            // Carrega lista de credenciais
            fetch('{{ url_for("admin_remote.api_ssh_list") }}')
                .then(r => r.json())
                .then(creds => {
                    credSelect.innerHTML = '';
                    creds.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = `${c.name_ssh} (${c.user_ssh}@${c.host_ssh})`;
                        credSelect.appendChild(opt);
                    });
                });

            // Fun√ß√£o util para adicionar item ao hist√≥rico com estilos
            function addToHistory(command, stdout, stderr) {
                const li = document.createElement('li');
                const isError = stderr && stderr.trim().length > 0;

                li.className = 'list-group-item history-item ' + (isError ? 'history-error' : 'history-success');

                li.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <b>[${new Date().toLocaleTimeString()}]</b> <strong>$ ${command}</strong>
                        ${isError 
                            ? '<span class="label label-danger">Erro</span>' 
                            : '<span class="label label-success">OK</span>'}
                    </div>
                    <pre class="command-output">${isError ? stderr : stdout}</pre>
                `;

                historyList.insertBefore(li, historyList.firstChild);
            }

            document.getElementById('clearHistoryBtn').addEventListener('click', () => {
                historyList.innerHTML = '';
            });

            // Execu√ß√£o do comando livre
            formFree.addEventListener('submit', e => {
                e.preventDefault();
                const credId = credSelect.value;
                const cmd = commandInput.value.trim();
                if (!cmd) return;

                fetch(`{{ url_for("admin_remote.api_ssh_execute", cred_id=0) }}`.replace('0', credId), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: cmd })
                })
                .then(r => r.json())
                .then(resp => {
                    addToHistory(cmd, resp.stdout || '', resp.stderr || '');
                })
                .catch(err => {
                    addToHistory(cmd, '', 'Erro inesperado: ' + err);
                });

                commandInput.value = '';
            });
        })();
    </script>
{% endblock extra_script %}
{% block extra_css %}
    <style>
        .history-item {S
            margin-bottom: 8px;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .history-success {
            background: #f4fff4;       /* verde bem clarinho */
            border-left: 4px solid #4caf50;
        }

        .history-error {
            background: #fff5f5;       /* vermelho bem clarinho */
            border-left: 4px solid #f44336;
        }

        .command-output {
            margin-top: 5px;
            white-space: pre-wrap;
            background: transparent;
            border: none;
            padding: 0;
        }

    </style>
{% endblock extra_css %}

{% extends "base-fixed" %}
{% block title %}
    Execu√ß√£o de Comandos
{% endblock title %}
{% block content %}
    <div class="panel panel-info">
        <div class="panel-heading">
            <h3 class="panel-title">
                <span class="glyphicon glyphicon-console"></span> Execu√ß√£o de Comandos SSH
            </h3>
        </div>
        <div class="panel-body">
            <!-- Abas -->
            <ul class="nav nav-tabs" role="tablist">
                <li class="active">
                    <a href="#tab-free" role="tab" data-toggle="tab">Execu√ß√£o Livre</a>
                </li>
                <li>
                    <a href="#tab-templates" role="tab" data-toggle="tab">Comandos Parametrizados</a>
                </li>
            </ul>
            <!-- Conte√∫do das Abas -->
            <div class="tab-content margin-top-15">
                <!-- ===================== ABA 1: EXECU√á√ÉO LIVRE ===================== -->
                <div class="tab-pane fade in active" id="tab-free">
                    <form id="formFreeCommand" class="margin-bottom-10">
                        <div class="form-inline margin-bottom-5">
                            <div class="form-group">
                                <label for="credSelect">Credencial:</label>
                                <select id="credSelect" class="form-control" required></select>
                            </div>
                            <div class="form-group wp60">
                                <label for="commandInput" class="sr-only">Comando</label>
                                <input type="text"
                                       id="commandInput"
                                       class="form-control full"
                                       placeholder="Digite um comando SSH..."
                                       required>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                <span class="glyphicon glyphicon-play"></span> Executar
                            </button>
                        </div>
                        <div class="form-group">
                            <label for="stdinInput">Entrada (stdin) opcional:</label>
                            <textarea id="stdinInput"
                                      class="form-control"
                                      rows="2"
                                      placeholder="Digite dados para enviar ao stdin do comando (opcional)"></textarea>
                        </div>
                    </form>
                    <div id="commandHistory">
                        <h4>Hist√≥rico</h4>
                        <div class="clearfix margin-bottom-5">
                            <button id="clearHistoryBtn"
                                    type="button"
                                    class="btn btn-xs btn-default pull-right">üßº Limpar hist√≥rico</button>
                        </div>
                        <ul class="list-group" id="historyList">
                        </ul>
                    </div>
                </div>
                <!-- ===================== ABA 2: COMANDOS PARAMETRIZADOS ===================== -->
                <div class="tab-pane fade" id="tab-templates">
                    <p>üõ†Ô∏è Em breve: aqui voc√™ poder√° configurar comandos com par√¢metros, salvar e reaproveitar.</p>
                </div>
            </div>
        </div>
    </div>
{% endblock content %}
{% block extra_script %}
    <script>
        (function() {
            const credSelect = document.getElementById('credSelect');
            const formFree = document.getElementById('formFreeCommand');
            const commandInput = document.getElementById('commandInput');
            const historyList = document.getElementById('historyList');

            // Carrega lista de credenciais
            fetch('{{ url_for("admin_remote.api_ssh_list") }}')
                .then(r => r.json())
                .then(creds => {
                    credSelect.innerHTML = '';
                    creds.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c.id;
                        opt.textContent = `${c.name_ssh} (${c.user_ssh}@${c.host_ssh})`;
                        credSelect.appendChild(opt);
                    });
                });

            function addToHistory(command, stdout, stderr, stdinData = '') {
                const history = document.getElementById('commandHistory');

                const entry = document.createElement('div');
                entry.className = 'history-entry';

                const cmdEl = document.createElement('div');
                cmdEl.className = 'history-command';

                const timeStr = new Date().toLocaleTimeString();
                cmdEl.innerHTML = `[${timeStr}] $ ${command}`;

                if (stdinData && stdinData.trim() !== '') {
                    cmdEl.innerHTML += ' <span class="stdin-badge">üìù stdin usado</span>';
                }

                // Bot√£o reexecutar
                const rerunBtn = document.createElement('button');
                rerunBtn.type = 'button';
                rerunBtn.className = 'btn btn-xs btn-default rerun-btn';
                rerunBtn.innerHTML = 'üîÅ';
                rerunBtn.title = 'Reexecutar comando';
                rerunBtn.addEventListener('click', () => {
                    rerunCommand(command, stdinData);
                });
                cmdEl.appendChild(rerunBtn);

                entry.appendChild(cmdEl);

                if (stdout && stdout.trim() !== '') {
                    const outEl = document.createElement('pre');
                    outEl.className = 'history-stdout';
                    outEl.textContent = stdout;
                    entry.appendChild(outEl);
                }

                if (stderr && stderr.trim() !== '') {
                    const errEl = document.createElement('pre');
                    errEl.className = 'history-stderr';
                    errEl.textContent = stderr;
                    entry.appendChild(errEl);
                }

                history.insertBefore(entry, history.firstChild);
            }

            function rerunCommand(command, stdinData) {
                const credId = credSelect.value;
                if (!credId) return;

                fetch(`{{ url_for("admin_remote.api_ssh_execute", cred_id=0) }}`.replace('0', credId), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: command, stdin: stdinData })
                })
                .then(r => r.json())
                .then(resp => {
                    addToHistory(command, resp.stdout || '', resp.stderr || '', stdinData);
                })
                .catch(err => {
                    addToHistory(command, '', 'Erro inesperado: ' + err, stdinData);
                });
            }

            document.getElementById('clearHistoryBtn').addEventListener('click', () => {
                historyList.innerHTML = '';
            });

            // Execu√ß√£o do comando livre
            formFree.addEventListener('submit', e => {
                e.preventDefault();
                const credId = credSelect.value;
                const cmd = commandInput.value.trim();
                const stdinData = document.getElementById('stdinInput').value;
                if (!cmd) return;

                fetch(`{{ url_for("admin_remote.api_ssh_execute", cred_id=0) }}`.replace('0', credId), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ command: cmd, stdin: stdinData })
                })
                .then(r => r.json())
                .then(resp => {
                    addToHistory(cmd, resp.stdout || '', resp.stderr || '', stdinData);
                })
                .catch(err => {
                    addToHistory(cmd, '', 'Erro inesperado: ' + err);
                });

                commandInput.value = '';
                document.getElementById('stdinInput').value = '';
            });
        })();
    </script>
{% endblock extra_script %}
{% block extra_css %}
    <style>
        #commandHistory {
            margin-top: 15px;
        }

        .history-entry {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 8px;
            margin-bottom: 10px;
            font-family: monospace;
        }

        .history-command {
            font-weight: bold;
            color: #333;
            margin-bottom: 6px;
        }

        .history-stdout {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 6px;
            margin: 0;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .history-stderr {
            background: #ffebee;
            border-left: 4px solid #f44336;
            padding: 6px;
            margin-top: 6px;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .stdin-badge {
            background-color: #2196f3;
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
            vertical-align: middle;
        }

        .rerun-btn {
            margin-left: 10px;
            padding: 0 5px;
            line-height: 1;
        }

    </style>
{% endblock extra_css %}

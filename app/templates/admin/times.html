{% extends "base-fixed" %}
{% block title %}
    Controle de Horários
{% endblock title %}
{% block content %}
    <div class="panel panel-info">
        <div class="panel-heading">
            <h3 class="panel-title">Horários (referentes ao dia {{ hoje|data }})</h3>
        </div>
        <div class="panel-body">
            <!-- Header row -->
            <div class="row schedule-header">
                <div class="col-xs-3">Turno</div>
                <div class="col-xs-2">Horários</div>
                {% for semana in dias_da_semana %}<div class="col-xs-1 text-center">{{ semana.nome_semana }}</div>{% endfor %}
            </div>
            <!-- Body rows -->
            {% for horario in horarios_base %}
                <div class="row schedule-row">
                    <!-- Turno column -->
                    <div class="col-xs-3 turno-cell" data-time="{{ horario.id_aula }}">
                        <span class="badge turno-badge" data-toggle="tooltip" title="placehold">???</span>
                    </div>
                    <!-- Horário column -->
                    <div class="col-xs-2 horario-cell">
                        <span class="glyphicon glyphicon-time"></span>
                        {{ horario.horario_inicio|hora }} às {{ horario.horario_fim|hora }}
                    </div>
                    <!-- Days columns -->
                    {% for semana in dias_da_semana %}
                        <div class="col-xs-1 day-cell text-center"
                             data-day="{{ hoje }}"
                             data-time="{{ horario.id_aula }}"
                             data-day-of-week="{{ semana.id_semana }}">
                            <span class="badge state-badge" data-toggle="tooltip" title="placehold">???</span>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
        <div class="panel-footer">
            <div class="btn-group btn-group-justified" role="group">
                <a href="#" class="btn btn-warning">Editar Período de Ativação</a>
                <a href="#" class="btn btn-info">Ver todos os Períodos</a>
            </div>
        </div>
    </div>
{% endblock content %}
{% block extra_script %}
    <script>
        $(document).ready(function () {
            /**
            * Atualiza ou inicializa tooltip de forma otimizada.
            */
            function setTooltip($el, text) {
                $el.attr('title', text).attr('data-original-title', text);
                const tooltipInstance = $el.data('bs.tooltip');

                if (tooltipInstance) {
                    // Se já está inicializado → só atualiza
                    $el.tooltip('fixTitle');
                } else {
                    // Se não está → inicializa uma vez
                    $el.tooltip({
                        container: 'body',
                        placement: 'bottom',
                        delay: { show: 150, hide: 100 }
                    });
                    $el.addClass('tooltip-initialized');
                }
            }

            // Lista de promessas (turnos + aulas ativas)
            const requests = [];

            // --- Turnos ---
            $(".turno-cell").each(function () {
                const cell = $(this);
                const horarioId = cell.data("time");

                const req = $.getJSON(`{{ url_for('admin.api_get_turno') }}?horario_id=${horarioId}`)
                    .done(function (response) {
                        const badge = cell.find(".turno-badge");
                        badge.text(response.turno || "???");
                        badge.removeClass("badge-dia badge-tarde badge-noite");

                        if (response.id == 1) badge.addClass("badge-dia");
                        else if (response.id == 2) badge.addClass("badge-tarde");
                        else if (response.id == 3) badge.addClass("badge-noite");

                        setTooltip(badge, response.periodo || "");
                    })
                    .fail(function () {
                        cell.find(".turno-badge").text("erro");
                    });

                requests.push(req);
            });

            // --- Aulas ativas ---
            $(".day-cell").each(function () {
                const cell = $(this);
                const day = cell.data("day");
                const horarioId = cell.data("time");
                const dayOfWeek = cell.data("day-of-week");

                const req = $.getJSON(`{{ url_for('admin.api_get_aulas_ativas') }}?day=${day}&aula=${horarioId}&semana=${dayOfWeek}`)
                    .done(function (response) {
                        const badge = cell.find(".state-badge");
                        badge.removeClass("badge-success badge-inactive");

                        if (response.ativa) {
                            badge.text("Ativa").addClass("badge-success");

                            let periodo = '';
                            if (response.data_inicio) periodo += `a partir de ${response.data_inicio}`;
                            if (response.data_fim) periodo += ` até ${response.data_fim}`;
                            if (!periodo) periodo = 'Ativa permanentemente';

                            setTooltip(badge, periodo);
                        } else {
                            badge.text("Inativa").addClass("badge-inactive");
                            setTooltip(badge, "Inativa");
                        }
                    })
                    .fail(function () {
                        cell.find(".state-badge").text("erro");
                    });

                requests.push(req);
            });

            // --- Inicializa tooltips pendentes ao fim ---
            Promise.all(requests).then(() => {
                $('[data-toggle="tooltip"]').not('.tooltip-initialized').tooltip({
                    container: 'body',
                    placement: 'bottom',
                    delay: { show: 150, hide: 100 }
                }).addClass('tooltip-initialized');
            });
        });
    </script>
{% endblock extra_script %}
{% block extra_css %}
    <link rel="stylesheet"
          href="{{ url_for('static', filename='css/times.css') }}">
{% endblock extra_css %}

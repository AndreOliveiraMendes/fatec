{% extends "base-fixed" %}
{% block title %}
    Controle de Horários
{% endblock title %}
{% block content %}
    <div class="panel panel-info">
        <div class="panel-heading clearfix">
            <h3 class="panel-title pull-left">Horários (referentes ao dia {{ hoje|data }})</h3>
            <div class="pull-right">
                <select id="tipoHorarioSelect" class="form-control input-sm">
                    <option value="Aula" selected>Aula</option>
                    <option value="Evento">Evento</option>
                    <option value="Outros">Outros</option>
                </select>
            </div>
        </div>
        <div class="panel-body">
            <!-- Header row -->
            <div class="row schedule-header">
                <div class="col-xs-3">Turno</div>
                <div class="col-xs-2">Horários</div>
                {% for semana in dias_da_semana %}
                    <div class="col-xs-1 text-center">{{ semana.nome_semana }}</div>
                {% endfor
                %}
            </div>
            <!-- Body rows -->
            {% for horario in horarios_base %}
                <div class="row schedule-row">
                    <!-- Turno column -->
                    <div class="col-xs-3 turno-cell" data-time="{{ horario.id_aula }}">
                        <span class="badge turno-badge" data-toggle="tooltip" title="placehold">???</span>
                    </div>
                    <!-- Horário column -->
                    <div class="col-xs-2 horario-cell">
                        <span class="glyphicon glyphicon-time"></span>
                        {{ horario.horario_inicio|hora }} às {{ horario.horario_fim|hora }}
                    </div>
                    <!-- Days columns -->
                    {% for semana in dias_da_semana %}
                        <div class="col-xs-1 day-cell text-center"
                             data-day="{{ hoje }}"
                             data-time="{{ horario.id_aula }}"
                             data-time-text="{{ horario.horario_inicio|hora }} - {{ horario.horario_fim|hora }}"
                             data-day-name="{{ semana.nome_semana }}"
                             data-day-of-week="{{ semana.id_semana }}">
                            <span class="badge state-badge" data-toggle="tooltip" title="placehold">???</span>
                        </div>
                    {% endfor %}
                </div>
            {% endfor %}
        </div>
        <div class="panel-footer">
            <div class="btn-group btn-group-justified" role="group">
                <a href="#modalGerenciar" data-toggle="modal" class="btn btn-warning">Editar Período de Ativação</a>
                <a href="#modalPeriodos" data-toggle="modal" class="btn btn-info">Ver todos os Períodos</a>
            </div>
        </div>
    </div>
    {% include "admin/_modal_gerenciar.html" %}
    {% include "admin/_modal_periodos.html" %}
{% endblock content %}
{% block extra_script %}
    <!-- Inicialização do painel de horários -->
    <script>
        $(function () {

            function setTooltip($el, text) {
                $el.attr('title', text).attr('data-original-title', text);
                const tooltipInstance = $el.data('bs.tooltip');
                if (tooltipInstance) {
                    $el.tooltip('fixTitle');
                } else {
                    $el.tooltip({
                        container: 'body',
                        placement: 'bottom',
                        delay: { show: 150, hide: 100 },
                        html: true
                    });
                    $el.addClass('tooltip-initialized');
                }
            }

            function carregarTurnos() {
                $(".turno-cell").each(function () {
                    const cell = $(this);
                    const horarioId = cell.data("time");

                    $.getJSON(`{{ url_for('admin.api_get_turno') }}?horario_id=${horarioId}`)
                        .done(function (response) {
                            const badge = cell.find(".turno-badge");
                            badge.text(response.turno || "???")
                                 .removeClass("badge-dia badge-tarde badge-noite");

                            if (response.id == 1) badge.addClass("badge-dia");
                            else if (response.id == 2) badge.addClass("badge-tarde");
                            else if (response.id == 3) badge.addClass("badge-noite");

                            setTooltip(badge, response.periodo || "");
                        })
                        .fail(function () {
                            cell.find(".turno-badge").text("erro");
                        });
                });
            }

            function carregarAulasAtivas(tipo) {
                $(".day-cell").each(function () {
                    const cell = $(this);
                    const day = cell.data("day");
                    const horarioId = cell.data("time");
                    const dayOfWeek = cell.data("day-of-week");
                    const badge = cell.find(".state-badge");

                    badge.text("...")
                         .removeClass("badge-success badge-inactive");

                    $.getJSON(`{{ url_for('admin.api_get_aulas_ativas') }}?day=${day}&aula=${horarioId}&semana=${dayOfWeek}&tipoaula=${tipo}`)
                        .done(function (response) {
                            badge.removeClass("badge-success badge-inactive");

                            if (response.ativa) {
                                badge.text("Ativa").addClass("badge-success");
                                let periodo = '';
                                if (response.inicio) periodo += `<b>Início:</b> ${response.inicio}<br>`;
                                if (response.fim) periodo += `<b>Fim:</b> ${response.fim}<br>`;
                                if (!periodo) periodo = '<i>Ativa permanentemente</i>';
                                setTooltip(badge, periodo);
                            } else {
                                badge.text("Inativa").addClass("badge-inactive");
                                setTooltip(badge, "Inativa");
                            }
                        })
                        .fail(function () {
                            badge.text("erro");
                        });
                });
            }

            const $tipoSelect = $('#tipoHorarioSelect');
            carregarTurnos();
            carregarAulasAtivas($tipoSelect.val());

            $tipoSelect.on("change", function () {
                carregarAulasAtivas($(this).val());
            });

            $("#formSelecionarContexto").hide();
        });
    </script>
    <!-- Modal: Listagem de períodos -->
    <script>
        let paginaAtual = 1;

        function carregarPeriodos(pagina = 1) {
            const params = new URLSearchParams(new FormData(document.getElementById('filtroPeriodosForm')));
            params.append('page', pagina);

            fetch(`{{ url_for('admin.api_listar_periodos') }}?${params.toString()}`)
                .then(r => r.json())
                .then(data => {
                    const lista = document.getElementById('listaPeriodos');
                    lista.innerHTML = '';

                    if (data.items.length === 0) {
                        lista.innerHTML = '<div class="alert alert-warning">Nenhum período encontrado.</div>';
                        const paginacao = document.getElementById('paginacaoPeriodos');
                        paginacao.innerHTML = '';
                        return;
                    }

                    const table = document.createElement('table');
                    table.className = 'table table-striped table-bordered';
                    table.innerHTML = `
                        <thead>
                            <tr>
                                <th>Semana</th>
                                <th>Tipo</th>
                                <th>Horário</th>
                                <th>Início Ativação</th>
                                <th>Fim Ativação</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.items.map(item => `
                                <tr>
                                    <td>${item.semana}</td>
                                    <td>${item.tipo}</td>
                                    <td>${item.horario}</td>
                                    <td>${item.inicio_ativacao}</td>
                                    <td>${item.fim_ativacao}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    `;
                    lista.appendChild(table);

                    const paginacao = document.getElementById('paginacaoPeriodos');
                    paginacao.innerHTML = '';
                    for (let i = 1; i <= data.total_pages; i++) {
                        const li = document.createElement('li');
                        if (i === data.page) li.classList.add('active');
                        const a = document.createElement('a');
                        a.href = '#';
                        a.textContent = i;
                        a.onclick = (e) => {
                            e.preventDefault();
                            paginaAtual = i;
                            carregarPeriodos(i);
                        };
                        li.appendChild(a);
                        paginacao.appendChild(li);
                    }
                });
        }

        document.getElementById('filtroPeriodosForm').addEventListener('submit', function (e) {
            e.preventDefault();
            carregarPeriodos(1);
        });

        $('#modalPeriodos').on('shown.bs.modal', function () {
            carregarPeriodos(1);
        });
    </script>
    <!-- Modal: Gerenciar períodos -->
    <script>
        function atualizarAbasGerenciar(ativa) {
            const $abasAtivar = $(".aba-ativar, .aba-ativar-temp");
            const $abasDesativar = $(".aba-desativar, .aba-extender");

            if (ativa) {
                $abasAtivar.addClass("disabled").find("a")
                           .removeAttr("data-toggle")
                           .css("pointer-events","none");
                $abasDesativar.removeClass("disabled").find("a")
                              .attr("data-toggle","tab")
                              .css("pointer-events","auto");
                $(".aba-desativar a").tab("show");
            } else {
                $abasAtivar.removeClass("disabled").find("a")
                           .attr("data-toggle","tab")
                           .css("pointer-events","auto");
                $abasDesativar.addClass("disabled").find("a")
                              .removeAttr("data-toggle")
                              .css("pointer-events","none");
                $(".aba-ativar a").tab("show");
            }
        }

        $(document).on("click", ".day-cell", function () {
            const horarioId = $(this).data("time");
            const horarioTexto = $(this).data("time-text");
            const semanaId = $(this).data("day-of-week");
            const semanaNome = $(this).data("day-name");
            const tipoSelecionado = $("#tipoHorarioSelect").val();

            // Guarda no modal pra usar no submit
            $("#modalGerenciar")
                .data("horario-id", horarioId)
                .data("semana-id", semanaId);

            $.getJSON(`{{ url_for('admin.api_get_aulas_ativas') }}?day={{ hoje }}&aula=${horarioId}&semana=${semanaId}&tipoaula=${tipoSelecionado}`)
                .done(function (response) {
                    const ativa = response.ativa;
                    $("#ctxAula").text(horarioTexto);
                    $("#ctxSemana").text(semanaNome);
                    $("#ctxTipo").text(tipoSelecionado);
                    $("#ctxStatus")
                        .text(ativa ? "Ativa" : "Inativa")
                        .removeClass("label-default label-success")
                        .addClass(ativa ? "label-success" : "label-default");

                    atualizarAbasGerenciar(ativa);
                    $("#modalGerenciar").modal("show");
                })
                .fail(function () {
                    alert("Erro ao carregar status da reserva.");
                });
        });

        $("#btnTrocarContexto").on("click", function () {
            $("#formSelecionarContexto").slideToggle();
        });

        $("#btnAplicarContexto").on("click", function () {
            const horarioId = $("#selectAula").val();
            const horarioTexto = $("#selectAula option:selected").text();
            const semanaId = $("#selectSemana").val();
            const semanaNome = $("#selectSemana option:selected").text();
            const tipo = $("#selectTipo").val();

            $.getJSON(`{{ url_for('admin.api_get_aulas_ativas') }}?day={{ hoje }}&aula=${horarioId}&semana=${semanaId}&tipoaula=${tipo}`)
                .done(function (response) {
                    const ativa = response.ativa;
                    $("#ctxAula").text(horarioTexto);
                    $("#ctxSemana").text(semanaNome);
                    $("#ctxTipo").text(tipo);
                    $("#ctxStatus")
                        .text(ativa ? "Ativa" : "Inativa")
                        .removeClass("label-default label-success")
                        .addClass(ativa ? "label-success" : "label-default");
                    atualizarAbasGerenciar(ativa);
                });
        });
    </script>
    <script>
        // Form: Ativar Temporariamente
        $("#formAtivarTemp").on("submit", function (e) {
            e.preventDefault();

            const inicio = $("#dataInicio").val();
            const fim = $("#dataFim").val();

            if (!inicio || !fim) return;

            // Pega contexto atual do modal
            const horarioTexto = $("#ctxAula").text();
            const semanaNome = $("#ctxSemana").text();
            const tipo = $("#ctxTipo").text();

            // Mas pra enviar, precisamos dos IDs, então guardamos no modal (vindo do click)
            const horarioId = $("#modalGerenciar").data("horario-id");
            const semanaId = $("#modalGerenciar").data("semana-id");

            const payload = {
                horario_id: horarioId,
                semana_id: semanaId,
                tipo: tipo,
                inicio: inicio,
                fim: fim
            };

            fetch(`{{ url_for('admin.api_ativar_temp') }}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
            })
            .then(r => {
                return r.json();
            })
            .then(data => {
                const alertBox = $("#alertAtivarTemp");
                if (data.success) {
                    alertBox.removeClass().addClass("alert alert-success")
                        .text("Período ativado temporariamente com sucesso!")
                        .slideDown();

                    // Recarrega o status REAL a partir da API
                    $.getJSON(`{{ url_for('admin.api_get_aulas_ativas') }}?day={{ hoje }}&aula=${horarioId}&semana=${semanaId}&tipoaula=${tipo}`)
                        .done(function (status) {
                            const ativa = status.ativa;

                            // Atualiza cabeçalho do modal
                            $("#ctxStatus")
                                .text(ativa ? "Ativa" : "Inativa")
                                .removeClass("label-default label-success")
                                .addClass(ativa ? "label-success" : "label-default");

                            atualizarAbasGerenciar(ativa);

                            // Atualiza badge da célula correspondente
                            const selector = `.day-cell[data-time='${horarioId}'][data-day-of-week='${semanaId}'] .state-badge`;
                            const $badge = $(selector);
                            if (ativa) {
                                let tooltipText = '';
                                if (status.inicio) tooltipText += `<b>Início:</b> ${status.inicio}<br>`;
                                if (status.fim) tooltipText += `<b>Fim:</b> ${status.fim}<br>`;
                                if (!tooltipText) tooltipText = '<i>Ativa permanentemente</i>';

                                $badge.text("Ativa")
                                    .removeClass("badge-inactive")
                                    .addClass("badge-success")
                                    .attr("title", tooltipText)
                                    .tooltip('fixTitle');
                            } else {
                                $badge.text("Inativa")
                                    .removeClass("badge-success")
                                    .addClass("badge-inactive")
                                    .attr("title", "Inativa")
                                    .tooltip('fixTitle');
                            }
                        });

                } else {
                    alertBox.removeClass().addClass("alert alert-danger")
                        .text(data.error || "Erro ao ativar período.")
                        .slideDown();
                }
            })
            .catch((error) => {
                console.error("Caught error:", error);
                $("#alertAtivarTemp")
                    .removeClass().addClass("alert alert-danger")
                    .text("Erro de conexão.")
                    .slideDown();
            });

        });
    </script>
{% endblock extra_script %}
{% block extra_css %}
    <link rel="stylesheet"
          href="{{ url_for('static', filename='css/times.css') }}">
{% endblock extra_css %}

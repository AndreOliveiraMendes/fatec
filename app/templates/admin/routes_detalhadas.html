{% extends "base-fixed" %}
{% block title %}
    Rotas Detalhadas
{% endblock title %}
{% block content %}
    <div class="panel panel-default">
        <div class="panel-heading clearfix">
            <h3 class="panel-title pull-left">
                <span class="glyphicon glyphicon-list-alt"></span> Rotas Detalhadas
                <span class="badge">{{ rotas|length }}</span>
            </h3>
            <div class="pull-right">
                <input type="text"
                       id="filtro"
                       class="form-control input-sm"
                       placeholder="Filtrar...">
            </div>
        </div>
        <div class="panel-body">
            <!-- Ocultar colunas -->
            <div class="dropdown mb-10">
                <button class="btn btn-default btn-sm dropdown-toggle"
                        type="button"
                        id="colDropdown"
                        data-toggle="dropdown">
                    <span class="glyphicon glyphicon-eye-open"></span> Colunas
                    <span class="caret"></span>
                </button>
                <ul class="dropdown-menu" aria-labelledby="colDropdown">
                    {% set colunas = [('URL', 'url'), ('Métodos', 'metodos'), ('Blueprint', 'blueprint'), ('Endpoint', 'endpoint'), ('URL Gerada', 'url_gerada'), ('Args URL', 'argumentos_url'), ('Defaults', 'defaults'), ('Subdomínio', 'subdominio'), ('View Nome', 'view_func_nome'), ('Módulo', 'view_func_modulo'), ('Docstring', 'view_func_doc'), ('Parâmetros', 'view_func_parametros')] %}
                    {% for nome, classe in colunas %}
                        <li>
                            <label class="ml-10">
                                <input type="checkbox"
                                       class="col-toggle"
                                       data-col="{{ loop.index0 }}"
                                       checked>
                                {{ nome }}
                            </label>
                        </li>
                    {% endfor %}
                    <li role="separator" class="divider"></li>
                    <li>
                        <button type="button"
                                id="reset-colunas"
                                class="btn btn-link btn-sm btn-reset-default">
                            <span class="glyphicon glyphicon-refresh"></span> Restaurar padrão
                        </button>
                    </li>
                </ul>
            </div>
            <!-- Tabela -->
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-condensed"
                       id="tabelaDetalhada">
                    <thead>
                        <tr>
                            {% for nome, classe in colunas %}<th class="col-{{ classe }}">{{ nome }}</th>{% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in rotas %}
                            <tr>
                                <td>
                                    <code>{{ r.url }}</code>
                                </td>
                                <td>
                                    {% for m in r.metodos %}
                                        {% set badge_class = 'badge-success' if m == 'GET' else
                                                                                    'badge-warning' if m == 'POST' else
                                                                                    'badge-info' if m in ['PUT','PATCH'] else
                                                                                    'badge-danger' if m == 'DELETE' else
                                                                                'badge-secondary' %}
                                        <span class="badge {{ badge_class }}">{{ m }}</span>
                                    {% endfor %}
                                </td>
                                <td>{{ r.blueprint or "(sem)" }}</td>
                                <td>{{ r.endpoint }}</td>
                                <td>
                                    <code>{{ r.url_gerada or "-" }}</code>
                                </td>
                                <td>{{ r.argumentos_url|join(", ") }}</td>
                                <td>
                                    {% if r.defaults %}
                                        <code>{{ r.defaults }}</code>
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                                <td>{{ r.subdominio or "-" }}</td>
                                <td>{{ r.view_func_nome or "-" }}</td>
                                <td>{{ r.view_func_modulo or "-" }}</td>
                                <td>{{ r.view_func_doc or "-" }}</td>
                                <td>
                                    {% if r.view_func_parametros %}
                                        {% for p in r.view_func_parametros %}
                                            <div>
                                                <strong>{{ p.nome }}</strong>
                                                {% if p.tipo %}<small class="text-muted">({{ p.tipo }})</small>{% endif %}
                                                {% if p.default %}=<code>{{ p.default }}</code>{% endif %}
                                            </div>
                                        {% endfor %}
                                    {% else %}
                                        -
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock content %}
{% block extra_script %}
    <script>
        (function() {
            const filtro = document.getElementById('filtro');
            const tabela = document.getElementById('tabelaDetalhada');
            const linhas = tabela.querySelectorAll('tbody tr');
            const checkboxes = document.querySelectorAll('.col-toggle');
            const STORAGE_KEY = 'rotas_detalhadas_colunas_visiveis';

            // 🧰 Aplica visibilidade a uma coluna específica
            function aplicarVisibilidade(colIndex, visivel) {
                const display = visivel ? '' : 'none';
                tabela.querySelectorAll('tr').forEach(tr => {
                    const cell = tr.children[colIndex];
                    if (cell) cell.style.display = display;
                });
            }

            // 💾 Salva preferências de colunas no localStorage
            function salvarPreferencias() {
                const prefs = {};
                checkboxes.forEach((cb, idx) => {
                    prefs[idx] = cb.checked;
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));
            }

            // 📌 Carrega preferências salvas e aplica
            function carregarPreferencias() {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return;
                try {
                    const prefs = JSON.parse(saved);
                    checkboxes.forEach((cb, idx) => {
                        if (idx in prefs) {
                            cb.checked = prefs[idx];
                            aplicarVisibilidade(idx, cb.checked);
                        }
                    });
                } catch(e) {
                    console.warn('⚠️ Erro ao carregar preferências de colunas:', e);
                }
            }

            // 🧼 Reseta todas as colunas pro padrão (todas visíveis)
            function resetarColunas() {
                checkboxes.forEach((cb, idx) => {
                    cb.checked = true;
                    aplicarVisibilidade(idx, true);
                });
                localStorage.removeItem(STORAGE_KEY);
            }

            // 🔍 Filtro global
            filtro.addEventListener('input', function() {
                const termo = this.value.toLowerCase();
                linhas.forEach(tr => {
                    const texto = tr.innerText.toLowerCase();
                    tr.style.display = texto.includes(termo) ? '' : 'none';
                });
            });

            // 👁️ Eventos de checkbox de colunas
            checkboxes.forEach((cb, idx) => {
                cb.addEventListener('change', function() {
                    aplicarVisibilidade(idx, this.checked);
                    salvarPreferencias();
                });
            });

            // 🚀 Inicializa
            carregarPreferencias();

            // 🧼 Botão reset
            const resetBtn = document.getElementById('reset-colunas');
            resetBtn.addEventListener('click', resetarColunas);
        })();
    </script>
{% endblock extra_script %}
{% block extra_css %}
    <style>
        th, td { vertical-align: top; }
        code { white-space: nowrap; }
        .dropdown-menu label {
            font-weight: normal;
            cursor: pointer;
        }
        .mb-10 {
            margin-bottom: 10px;
        }
        .ml-10 {
            margin-left: 10px;
        }
        .btn-reset-defaul{
            width: 100%;
            text-align: left;
            padding-left: 10px
        }
    </style>
{% endblock extra_css %}

{% extends "base-fixed" %}
{% block title %}
    Rotas Detalhadas
{% endblock title %}
{% block content %}
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">
                <span class="glyphicon glyphicon-list-alt"></span>
                Rotas Detalhadas
                <span class="badge">{{ rotas|length }}</span>
            </h3>
        </div>
        <div class="panel-body">
            <!-- üîç Barra de filtro -->
            <div class="row">
                <div class="col-sm-6">
                    <input type="text"
                           id="filtroRotas"
                           class="form-control input-sm"
                           placeholder="Filtrar por qualquer campo...">
                </div>
                <div class="col-sm-6 text-right">
                    <!-- üëÅÔ∏è Op√ß√µes de colunas -->
                    <div class="dropdown">
                        <button class="btn btn-default btn-sm dropdown-toggle"
                                type="button"
                                data-toggle="dropdown">
                            <span class="glyphicon glyphicon-eye-open"></span> Colunas <span class="caret"></span>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-right ajust" id="colunasDropdown">
                            <li>
                                <label>
                                    <input type="checkbox" data-col="0" checked>
                                    URL
                                </label>
                            </li>
                            <li>
                                <label>
                                    <input type="checkbox" data-col="1" checked>
                                    M√©todos
                                </label>
                            </li>
                            <li>
                                <label>
                                    <input type="checkbox" data-col="2" checked>
                                    Blueprint
                                </label>
                            </li>
                            <li>
                                <label>
                                    <input type="checkbox" data-col="3" checked>
                                    Endpoint
                                </label>
                            </li>
                            <li>
                                <label>
                                    <input type="checkbox" data-col="4" checked>
                                    Fun√ß√£o
                                </label>
                            </li>
                            <li>
                                <label>
                                    <input type="checkbox" data-col="5" checked>
                                    M√≥dulo
                                </label>
                            </li>
                            <li>
                                <label>
                                    <input type="checkbox" data-col="6" checked>
                                    Args
                                </label>
                            </li>
                            <li>
                                <label>
                                    <input type="checkbox" data-col="7" checked>
                                    Defaults
                                </label>
                            </li>
                            <li>
                                <label>
                                    <input type="checkbox" data-col="8" checked>
                                    Strict?
                                </label>
                            </li>
                            <li>
                                <label>
                                    <input type="checkbox" data-col="9" checked>
                                    Subdom√≠nio
                                </label>
                            </li>
                            <li role="separator" class="divider"></li>
                            <li class="text-center">
                                <button id="resetColunas" type="button" class="btn btn-link btn-xs">
                                    <span class="glyphicon glyphicon-refresh"></span> Restaurar padr√£o
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <br>
            <!-- üß≠ Tabela -->
            <div class="table-responsive">
                <table class="table table-striped table-bordered table-condensed"
                       id="tabelaRotasDetalhadas">
                    <thead>
                        <tr>
                            <th>URL</th>
                            <th>M√©todos</th>
                            <th>Blueprint</th>
                            <th>Endpoint</th>
                            <th>Fun√ß√£o</th>
                            <th>M√≥dulo</th>
                            <th>Args</th>
                            <th>Defaults</th>
                            <th>Strict?</th>
                            <th>Subdom√≠nio</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in rotas %}
                            <tr>
                                <td>
                                    <code>{{ r.url }}</code>
                                </td>
                                <td>
                                    {% for m in r.methods %}<span class="badge">{{ m }}</span>{% endfor %}
                                </td>
                                <td>{{ r.blueprint }}</td>
                                <td>{{ r.endpoint }}</td>
                                <td>{{ r.function or '-' }}</td>
                                <td>
                                    <small>{{ r.module or '-' }}</small>
                                </td>
                                <td>{{ r.args|join(", ") if r.args else '-' }}</td>
                                <td>{{ r.defaults or '-' }}</td>
                                <td>{{ 'Sim' if r.strict_slashes else 'N√£o' }}</td>
                                <td>{{ r.subdomain }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock content %}
{% block extra_script %}
    <script>
        (function () {
            const filtro = document.getElementById('filtroRotas');
            const tabela = document.getElementById('tabelaRotasDetalhadas');
            const linhas = tabela.querySelectorAll('tbody tr');
            const checkboxes = document.querySelectorAll('#colunasDropdown input[type="checkbox"]');
            const resetBtn = document.getElementById('resetColunas');
            const STORAGE_KEY = 'rotas_colunas_visiveis';

            // üìå Carrega prefer√™ncias salvas
            function carregarPreferencias() {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return;

                try {
                    const prefs = JSON.parse(saved);
                    checkboxes.forEach(cb => {
                        const colIndex = cb.dataset.col;
                        if (colIndex in prefs) {
                            cb.checked = prefs[colIndex];
                            aplicarVisibilidade(colIndex, cb.checked);
                        }
                    });
                } catch (e) {
                    console.warn('‚ö†Ô∏è Erro ao carregar prefer√™ncias de colunas:', e);
                }
            }

            // üíæ Salva prefer√™ncias
            function salvarPreferencias() {
                const prefs = {};
                checkboxes.forEach(cb => {
                    prefs[cb.dataset.col] = cb.checked;
                });
                localStorage.setItem(STORAGE_KEY, JSON.stringify(prefs));
            }

            // üëÅÔ∏è Aplica visibilidade de uma coluna
            function aplicarVisibilidade(colIndex, visivel) {
                const display = visivel ? '' : 'none';
                tabela.querySelectorAll('tr').forEach(tr => {
                    const cell = tr.children[colIndex];
                    if (cell) cell.style.display = display;
                });
            }

            // üßº Restaurar padr√£o (todas vis√≠veis)
            function resetarColunas() {
                checkboxes.forEach(cb => {
                    cb.checked = true;
                    aplicarVisibilidade(cb.dataset.col, true);
                });
                localStorage.removeItem(STORAGE_KEY);
            }

            // üîç Filtro em tempo real
            filtro.addEventListener('input', function () {
                const termo = this.value.toLowerCase();
                linhas.forEach(tr => {
                    const match = tr.innerText.toLowerCase().includes(termo);
                    tr.style.display = match ? '' : 'none';
                });
            });

            // üëÅÔ∏è Eventos de checkboxes
            checkboxes.forEach(cb => {
                cb.addEventListener('change', function () {
                    aplicarVisibilidade(this.dataset.col, this.checked);
                    salvarPreferencias();
                });
            });

            // üßº Evento de reset
            resetBtn.addEventListener('click', resetarColunas);

            // üöÄ Inicializa
            carregarPreferencias();
        })();
    </script>
{% endblock extra_script %}
{% block extra_css %}
    <style>
        .ajust {
            max-height: 300px;
            overflow-y: auto
        }
    </style>
{% endblock extra_css %}

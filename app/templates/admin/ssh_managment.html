{% extends "base-fixed" %}
{% block title %}
    Central de SSH
{% endblock title %}
{% block content %}
    <div class="panel panel-default">
        <div class="panel-heading clearfix">
            <h3 class="panel-title pull-left">
                <span class="glyphicon glyphicon-lock"></span> Gerenciamento de Credenciais SSH
            </h3>
            <div class="pull-right">
                <button id="btnAddCred" class="btn btn-primary btn-sm">
                    <span class="glyphicon glyphicon-plus"></span> Nova Credencial
                </button>
            </div>
        </div>
        <div class="panel-body">
            <table class="table table-striped table-bordered" id="tableCreds">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Host</th>
                        <th>Usuário</th>
                        <th>Porta</th>
                        <th>Chave?</th>
                        <th>Ações</th>
                    </tr>
                </thead>
            </table>
        </div>
    </div>
    <!-- Modal de edição -->
    <div class="modal fade" id="modalCred" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form id="formCred">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal">×</button>
                        <h4 class="modal-title">Credencial SSH</h4>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" name="id">
                        <div class="form-group">
                            <label>Nome</label>
                            <input type="text" name="name_ssh" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Host</label>
                            <input type="text" name="host_ssh" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Usuário</label>
                            <input type="text" name="user_ssh" class="form-control" required>
                        </div>
                        <div class="form-group">
                            <label>Porta</label>
                            <input type="number"
                                   name="port_ssh"
                                   class="form-control"
                                   value="22"
                                   required>
                        </div>
                        <div class="form-group">
                            <label>Tipo de autenticação</label>
                            <br>
                            <label class="radio-inline">
                                <input type="radio" name="auth_type" value="password" checked>
                                Senha
                            </label>
                            <label class="radio-inline">
                                <input type="radio" name="auth_type" value="key">
                                Chave
                            </label>
                        </div>
                        <div id="fieldPassword" class="form-group">
                            <label>Senha</label>
                            <input type="password" name="password_ssh" class="form-control">
                            <span id="fieldPasswordMsg"
                                  class="help-block"
                                  data-original-html="Opcional se usar <strong>chave</strong>">
                                Opcional se usar <strong>chave</strong>
                            </span>
                        </div>
                        <div id="fieldKey" class="form-group hide">
                            <label>Chave privada</label>
                            <textarea name="key_ssh" class="form-control" rows="4"></textarea>
                            <span id="fieldKeyMsg"
                                  class="help-block"
                                  data-original-html="Cole o conteúdo da chave aqui ou <strong>faça upload</strong> de um arquivo de chave privada (.pem, .key, .txt ou sem extensão).">
                                Cole o conteúdo da chave aqui ou <strong>faça upload</strong> de um arquivo de chave privada (.pem, .key, .txt ou sem extensão).
                            </span>
                            <input type="file" id="keyFileInput"  class="form-control margin-top-5">
                        </div>
                        <div id="fieldKeyPass" class="form-group hide">
                            <label>Passphrase da chave (opcional)</label>
                            <input type="password" name="key_passphrase" class="form-control">
                            <span id="fieldKeyPassphraseMsg"
                                  class="help-block"
                                  data-original-html="Se a chave privada tiver passphrase, informe aqui">
                                Se a chave privada tiver passphrase, informe aqui
                            </span>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock content %}
{% block extra_script %}
    <script>
    (function () {
        const table = document.querySelector('#tableCreds');

        // Check if tbody exists
        let tableBody = table.querySelector('tbody');

        if (!tableBody) {
            // Create tbody if it doesn't exist
            tableBody = document.createElement('tbody');
            // Optionally set an ID or any other attributes
            tableBody.id = 'tableBody';
            // Append tbody to the table
            table.appendChild(tableBody);
        }

        // Função utilitária para alternar os campos de acordo com o tipo de autenticação
        function updateAuthFields(form) {
            const type = form.querySelector('input[name="auth_type"]:checked').value;
            const fieldPassword = document.getElementById('fieldPassword');
            const fieldKey = document.getElementById('fieldKey');
            const fieldKeyPass = document.getElementById('fieldKeyPass');

            // Garante que não fiquem ocultos permanentemente
            fieldKey.classList.remove('hide');
            fieldKeyPass.classList.remove('hide');

            // Exibe/esconde conforme o tipo
            fieldPassword.style.display = (type === 'password') ? '' : 'none';
            fieldKey.style.display = (type === 'key') ? '' : 'none';
            fieldKeyPass.style.display = (type === 'key') ? '' : 'none';
        }

        function setEditMode(isEditing, form) {
            const auth_type = form.querySelector('input[name="auth_type"]:checked').value;

            const fieldPasswordMsg = document.getElementById('fieldPasswordMsg');
            const fieldKeyMsg = document.getElementById('fieldKeyMsg');
            const fieldKeyPassphraseMsg = document.getElementById('fieldKeyPassphraseMsg');

            if (isEditing) {
                if (auth_type === 'password') {
                    fieldPasswordMsg.innerHTML = "Preencha para substituir a senha atual";
                } else if (auth_type === 'key') {
                    fieldKeyMsg.innerHTML = "Preencha ou faça upload para substituir a chave atual";
                    fieldKeyPassphraseMsg.innerHTML = "Preencha para atribuir ou substituir a senha da chave atual";
                }
            } else {
                fieldPasswordMsg.innerHTML = fieldPasswordMsg.dataset.originalHtml;
                fieldKeyMsg.innerHTML = fieldKeyMsg.dataset.originalHtml;
                fieldKeyPassphraseMsg.innerHTML = fieldKeyPassphraseMsg.dataset.originalHtml;
            }
        }

        const modal = $('#modalCred');
        const form = document.getElementById('formCred');

        // Leitura automática do arquivo de chave privada
        const keyFileInput = document.getElementById('keyFileInput');
        const keyTextArea = form.querySelector('textarea[name="key_ssh"]');

        keyFileInput.addEventListener('change', () => {
            const file = keyFileInput.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result.trim();
                if (!content.startsWith('-----BEGIN')) {
                    alert('O arquivo selecionado não parece conter uma chave privada válida.');
                    keyFileInput.value = ''; // limpa o input
                    return;
                }
                keyTextArea.value = content;
            };
            reader.readAsText(file);
        });

        // Alterna campos quando muda o tipo de autenticação
        form.querySelectorAll('input[name="auth_type"]').forEach(radio => {
            radio.addEventListener('change', () => updateAuthFields(form));
        });

        function carregarCredenciais() {
            fetch('{{ url_for("admin_remote_credential.api_ssh_list") }}')
                .then(r => r.json())
                .then(data => {
                    tableBody.innerHTML = '';
                    if (data.length === 0) {
                        tableBody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Nenhuma credencial cadastrada.</td></tr>`;
                        return;
                    }
                    data.forEach(c => {
                        const tr = document.createElement('tr');
                        tr.innerHTML = `
                            <td>${c.id}</td>
                            <td>${c.name_ssh}</td>
                            <td>${c.host_ssh}</td>
                            <td>${c.user_ssh}</td>
                            <td>${c.port_ssh}</td>
                            <td>
                                ${c.key_ssh
                                    ? `<span class="label label-success">Sim</span> ${c.key_passphrase ? '<span class="glyphicon glyphicon-lock text-muted" title="Chave com passphrase"></span>' : ''}`
                                    : '<span class="label label-default">Não</span>'}
                            </td>
                            <td>
                                <button class="btn btn-xs btn-success btn-test" data-id="${c.id}" title="Testar conexão">
                                    <span class="glyphicon glyphicon-console"></span>
                                </button>
                                <button class="btn btn-xs btn-info btn-edit" data-id="${c.id}" title="Editar">
                                    <span class="glyphicon glyphicon-pencil"></span>
                                </button>
                                <button class="btn btn-xs btn-danger btn-del" data-id="${c.id}" title="Excluir">
                                    <span class="glyphicon glyphicon-trash"></span>
                                </button>
                            </td>
                        `;
                        tableBody.appendChild(tr);
                    });
                });
        }

        // Abrir modal de criação
        document.getElementById('btnAddCred').addEventListener('click', () => {
            form.reset();
            keyFileInput.value = '';
            form.id.value = '';
            updateAuthFields(form);
            setEditMode(false, form);
            modal.modal('show');
        });

        // Salvar credencial
        form.addEventListener('submit', e => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(form).entries());
            if (data.port_ssh) data.port_ssh = parseInt(data.port_ssh);

            fetch('{{ url_for("admin_remote_credential.api_ssh_save") }}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
                .then(r => r.json())
                .then(resp => {
                    if (resp.success) {
                        modal.modal('hide');
                        carregarCredenciais();
                    } else {
                        alert('Erro ao salvar');
                    }
                });
        });

        // Editar / deletar (delegado)
        tableBody.addEventListener('click', e => {
            const editBtn = e.target.closest('.btn-edit');
            const delBtn = e.target.closest('.btn-del');
            const testBtn = e.target.closest('.btn-test');

            if (editBtn) {
                const id = editBtn.dataset.id;
                form.reset();
                fetch('{{ url_for("admin_remote_credential.api_ssh_list") }}')
                    .then(r => r.json())
                    .then(data => {
                        const cred = data.find(c => c.id == id);
                        if (cred) {
                            // Preenche campos simples
                            const SENSITIVE_FIELDS = ['password_ssh', 'key_ssh', 'key_passphrase'];

                            for (const k in cred) {
                                if (SENSITIVE_FIELDS.includes(k)) continue;

                                if (form[k]) {
                                    if (k === 'auth_type') {
                                        const radio = form.querySelector(`input[name="auth_type"][value="${cred[k]}"]`);
                                        if (radio) radio.checked = true;
                                    } else {
                                        form[k].value = cred[k];
                                    }
                                }
                            }

                            // Atualiza visibilidade dos campos
                            keyFileInput.value = '';
                            updateAuthFields(form);
                            setEditMode(true, form);
                            modal.modal('show');
                        }
                    });
            }

            if (delBtn) {
                const id = delBtn.dataset.id;
                if (!confirm('Tem certeza que deseja excluir esta credencial?')) return;
                fetch(`{{ url_for("admin_remote_credential.api_ssh_delete", cred_id=0) }}`.replace('0', id), {
                    method: 'POST'
                })
                    .then(r => r.json())
                    .then(resp => {
                        if (resp.success) carregarCredenciais();
                    });
            }

            if (testBtn) {
                const id = testBtn.dataset.id;
                testBtn.disabled = true;
                testBtn.classList.add('loading');

                fetch(`{{ url_for("admin_remote_credential.api_ssh_test", cred_id=0) }}`.replace('0', id), {
                    method: 'POST'
                })
                    .then(r => r.json())
                    .then(resp => {
                        if (resp.success) {
                            alert(resp.message || 'Conexão bem-sucedida!');
                        } else {
                            alert('❌ ' + (resp.error || 'Falha ao conectar.'));
                        }
                    })
                    .catch(err => {
                        alert('Erro inesperado: ' + err);
                    })
                    .finally(() => {
                        testBtn.disabled = false;
                        testBtn.classList.remove('loading');
                    });
            }
        });

        // Inicializa
        carregarCredenciais();
    })();
    </script>
{% endblock extra_script %}
{% block extra_css %}
    <style>
    .btn-test.loading {
        opacity: 0.7;
        pointer-events: none;
    }

    .btn-test.loading span::after {
        content: " …";
        font-weight: bold;
    }

    .glyphicon-lock {
        font-size: 12px;
        vertical-align: middle;
        margin-left: 4px;
    }
    </style>
{% endblock extra_css %}

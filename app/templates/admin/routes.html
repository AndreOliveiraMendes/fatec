{% extends "base-fixed" %}
{% block title %}
    Controle de Rotas e Blueprints
{% endblock title %}
{% block content %}
    <div class="panel panel-default">
        <div class="panel-heading">
            <ul class="nav nav-tabs">
                <li class="active">
                    <a href="#tab-rotas" data-toggle="tab">
                        <span class="glyphicon glyphicon-random"></span>
                        Rotas
                        <span class="badge">{{ rotas|length }}</span>
                    </a>
                </li>
                <li>
                    <a href="#tab-blueprints" data-toggle="tab">
                        <span class="glyphicon glyphicon-folder-open"></span>
                        Blueprints
                        <span class="badge">{{ blueprints|length }}</span>
                    </a>
                </li>
                <li>
                    <a href="#tab-config-archives" data-toggle="tab">
                        <span class="glyphicon glyphicon-cog"></span>
                        Arquivos de configuração
                        <span class="badge">{{ config_archives|length }}</span></a>
                </li>
                <li>
                    <a href="#tab-data-archives" data-toggle="tab">
                        <span class="glyphicon glyphicon-cog"></span>
                        Arquivos de dados
                        <span class="badge">{{ data_archives|length }}</span></a>
                </li>
            </ul>
        </div>
        <div class="panel-body tab-content">
            <!-- Aba de Rotas -->
            <div class="tab-pane fade in active" id="tab-rotas">
                <div class="row">
                    <div class="col-sm-6">
                        <h4>
                            <span class="glyphicon glyphicon-random text-primary"></span>
                            Rotas registradas
                            (<span id="contadorVisiveis">{{ rotas|length }}</span> de {{ rotas|length }})
                        </h4>
                    </div>
                    <div class="col-sm-6 text-right">
                        <input type="text"
                               id="filtroRotas"
                               class="form-control input-sm"
                               placeholder="Filtrar por URL, método, endpoint ou blueprint...">
                    </div>
                </div>
                <br>
                <div class="table-responsive">
                    <table class="table table-striped table-bordered table-condensed"
                           id="tabelaRotas">
                        <thead>
                            <tr>
                                <th class="w35p">URL</th>
                                <th class="w20p">Métodos</th>
                                <th class="w25p">Endpoint</th>
                                <th class="w20p">Blueprint</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for url, methods, endpoint in rotas %}
                                <tr>
                                    <td>
                                        <code>{{ url }}</code>
                                    </td>
                                    <td>
                                        {% for method in methods.split(',') %}
                                            {% set badge_class = 'badge-success' if method == 'GET' else
                                                                                            'badge-warning' if method == 'POST' else
                                                                                            'badge-info' if method in ['PUT','PATCH'] else
                                                                                            'badge-danger' if method == 'DELETE' else
                                                                                        'badge-secondary' %}
                                            <span class="badge {{ badge_class }}">{{ method }}</span>
                                        {% endfor %}
                                    </td>
                                    <td>{{ endpoint }}</td>
                                    <td>{{ endpoint.split(".")[0] if "." in endpoint else "(sem_blueprint)" }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Aba de Blueprints -->
            <div class="tab-pane fade" id="tab-blueprints">
                <div class="row">
                    <div class="col-sm-6">
                        <h4>
                            <span class="glyphicon glyphicon-folder-open text-info"></span>
                            Blueprints registradas (<span id="contadorBlueprints">{{ blueprints|length }}</span>)
                        </h4>
                    </div>
                    <div class="col-sm-6 text-right">
                        <input type="text"
                               id="filtroBlueprints"
                               class="form-control input-sm"
                               placeholder="Filtrar blueprints...">
                    </div>
                </div>
                <br>
                <ul class="list-group" id="listaBlueprints">
                    {% for nome, count in blueprints %}
                        <li class="list-group-item clearfix">
                            <span class="glyphicon glyphicon-link text-muted"></span>
                            <strong>{{ nome }}</strong>
                            <span class="badge pull-right">{{ count }} rota{{ 's' if count != 1 }}</span>
                        </li>
                    {% endfor %}
                </ul>
            </div>
            <!-- Aba de arquivos de configuração -->
            <div class="tab-pane fade" id="tab-config-archives">
                <h4>Arquivos de configuração</h4>
                <table class="table table-striped table-condensed sortable" id="table-config">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Tipo</th>
                            <th>Tamanho</th>
                            <th>Permissões</th>
                            <th>Dono</th>
                            <th>Grupo</th>
                            <th>Última modificação</th>
                        </tr>
                        <!-- a linha de filtros é gerada dinamicamente -->
                    </thead>
                    <tbody>
                        {% for a in config_archives %}
                            <tr>
                                <td>{{ a.nome }}</td>
                                <td>{{ a.tipo }}</td>
                                <td>{{ a.tamanho_formatado }}</td>
                                <td>
                                    <code>{{ a.permissoes }}</code>
                                </td>
                                <td>{{ a.owner }}</td>
                                <td>{{ a.group }}</td>
                                <td>{{ a.modificado_em|datahora }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <!-- Aba de arquivos de dados -->
            <div class="tab-pane fade" id="tab-data-archives">
                <h4>Arquivos de dados</h4>
                <table class="table table-striped table-condensed sortable" id="table-data">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Tipo</th>
                            <th>Tamanho</th>
                            <th>Permissões</th>
                            <th>Dono</th>
                            <th>Grupo</th>
                            <th>Última modificação</th>
                        </tr>
                        <!-- a linha de filtros é gerada dinamicamente -->
                    </thead>
                    <tbody>
                        {% for a in data_archives %}
                            <tr>
                                <td>{{ a.nome }}</td>
                                <td>{{ a.tipo }}</td>
                                <td>{{ a.tamanho_formatado }}</td>
                                <td>
                                    <code>{{ a.permissoes }}</code>
                                </td>
                                <td>{{ a.owner }}</td>
                                <td>{{ a.group }}</td>
                                <td>{{ a.modificado_em|datahora }}</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
{% endblock content %}
{% block extra_script %}
    <!-- aba de rotas -->
    <script>
        (function () {
            const filtro = document.getElementById('filtroRotas');
            const linhas = document.querySelectorAll('#tabelaRotas tbody tr');
            const contador = document.getElementById('contadorVisiveis');
            const total = linhas.length;

            filtro.addEventListener('input', function () {
                const termo = this.value.toLowerCase();
                let visiveis = 0;

                linhas.forEach(tr => {
                    const texto = tr.innerText.toLowerCase();
                    const match = texto.includes(termo);
                    tr.style.display = match ? '' : 'none';
                    if (match) visiveis++;
                });

                contador.textContent = visiveis;
            });
        })();
    </script>
    <!-- aba de blueprints -->
    <script>
        (function () {
            // Filtro da aba de Blueprints
            const filtroBp = document.getElementById('filtroBlueprints');
            const itensBp = document.querySelectorAll('#listaBlueprints li');
            const contadorBp = document.getElementById('contadorBlueprints');

            filtroBp.addEventListener('input', function () {
                const termo = this.value.toLowerCase();
                let visiveis = 0;
                itensBp.forEach(li => {
                    const texto = li.innerText.toLowerCase();
                    const match = texto.includes(termo);
                    li.style.display = match ? '' : 'none';
                    if (match) visiveis++;
                });
                contadorBp.textContent = visiveis;
            });
        })();
    </script>
    <!-- arquivos -->
    <script>
        function init_table(table_id){
            //const table = document.querySelector("table.sortable");
            const table = document.getElementById(table_id);
            if (!table) return;

            const thead = table.querySelector("thead");
            const headers = thead.querySelectorAll("tr:first-child > th");
            const filterRow = document.createElement("tr");

            // 🔸 Cria linha de filtros
            headers.forEach((header, index) => {
                const filterCell = document.createElement("th");
                const input = document.createElement("input");
                input.type = "text";
                input.className = "form-control input-sm";
                input.placeholder = "Filtrar...";
                input.dataset.column = index;
                input.addEventListener("input", filterTable);
                filterCell.appendChild(input);
                filterRow.appendChild(filterCell);
            });

            thead.appendChild(filterRow);

            // 🔸 Botão de limpar filtros
            const filterToolsRow = document.createElement("tr");
            const filterToolsCell = document.createElement("th");
            filterToolsCell.colSpan = headers.length;
            filterToolsCell.style.textAlign = "right";
            filterToolsCell.style.backgroundColor = "#f8f8f8";
            filterToolsCell.style.padding = "6px";

            const clearBtn = document.createElement("button");
            clearBtn.textContent = "Limpar filtros";
            clearBtn.className = "btn btn-xs btn-default";
            clearBtn.addEventListener("click", clearFilters);

            filterToolsCell.appendChild(clearBtn);
            filterToolsRow.appendChild(filterToolsCell);
            thead.appendChild(filterToolsRow);

            // 🔸 Prepara valores de ordenação (data-sort-value)
            table.querySelectorAll("tbody tr").forEach(row => {
                const cells = row.querySelectorAll("td");
                if (cells.length === 0) return;

                // Tipo (coluna 1)
                const tipoCell = cells[1];
                const tipoTxt = tipoCell.innerText.trim().toLowerCase();
                tipoCell.dataset.sortValue = tipoTxt.includes("diretório") ? 0 : 1;

                // Tamanho (coluna 2)
                const tamanhoCell = cells[2];
                const tamanhoTxt = tamanhoCell.innerText.trim();
                tamanhoCell.dataset.sortValue = parseSizeToBytes(tamanhoTxt);

                // Última modificação (coluna 6)
                const modCell = cells[6];
                const modTxt = modCell.innerText.trim();
                modCell.dataset.sortValue = parseDateToTimestamp(modTxt);
            });

            function parseSizeToBytes(sizeStr) {
                if (!sizeStr) return 0;
                const units = { b: 1, kb: 1024, mb: 1024 ** 2, gb: 1024 ** 3 };
                const match = sizeStr.toLowerCase().match(/([\d.,]+)\s*([kmgb]*)b?/);
                if (!match) return 0;
                const num = parseFloat(match[1].replace(",", ".")) || 0;
                const unit = match[2] || "b";
                return num * (units[unit] || 1);
            }

            function parseDateToTimestamp(dateStr) {
                if (!dateStr) return 0;
                // Tenta formato dd/mm/yyyy hh:mm:ss
                const parts = dateStr.match(/(\d{1,2})\/(\d{1,2})\/(\d{4})\s+(\d{1,2}):(\d{2})(?::(\d{2}))?/);
                if (parts) {
                    const [_, d, m, y, hh, mm, ss] = parts;
                    return new Date(y, m - 1, d, hh, mm, ss || 0).getTime();
                }
                // fallback pra Date.parse
                const ts = Date.parse(dateStr);
                return isNaN(ts) ? 0 : ts;
            }

            // Configuração de ordenação (alterado)
            const headerDirections = {};
            headers.forEach((header, index) => {
                header.style.cursor = "pointer";
                header.addEventListener("click", () => {
                    sortTableByColumn(index);
                    updateHeaderIcons(index);
                });
            });

            function sortTableByColumn(columnIndex) {
                const rows = Array.from(table.querySelectorAll("tbody > tr"));
                const currentDir = headerDirections[columnIndex] || "asc";
                const newDir = currentDir === "asc" ? "desc" : "asc";
                headerDirections[columnIndex] = newDir;

                rows.sort((a, b) => {
                    const aCell = a.cells[columnIndex];
                    const bCell = b.cells[columnIndex];
                    const aVal = aCell?.dataset.sortValue ?? aCell.innerText.trim();
                    const bVal = bCell?.dataset.sortValue ?? bCell.innerText.trim();

                    const aNum = parseFloat(aVal);
                    const bNum = parseFloat(bVal);

                    const bothNumeric = !isNaN(aNum) && !isNaN(bNum);
                    if (bothNumeric) {
                        return newDir === "asc" ? aNum - bNum : bNum - aNum;
                    } else {
                        return newDir === "asc"
                            ? String(aVal).localeCompare(String(bVal))
                            : String(bVal).localeCompare(String(aVal));
                    }
                });

                const tbody = table.querySelector("tbody");
                rows.forEach(row => tbody.appendChild(row));
            };

            function updateHeaderIcons(columnIndex) {
                // Limpa os ícones de todas as colunas
                headers.forEach((header, index) => {
                    const icon = header.querySelector("span");
                    if (icon) {
                        header.removeChild(icon);
                    }
                });

                // Adiciona a seta de ordenação para a coluna atual
                const header = headers[columnIndex];
                const iconSpan = document.createElement("span");
                iconSpan.className = "glyphicon";
                
                if (headerDirections[columnIndex] === "asc") {
                    iconSpan.classList.add("glyphicon-arrow-down");
                } else {
                    iconSpan.classList.add("glyphicon-arrow-up");
                }
                
                header.appendChild(iconSpan);
            }

            // 🔸 Filtro por coluna
            function filterTable() {
                const inputs = table.querySelectorAll("thead input");
                const rows = table.querySelectorAll("tbody tr");

                rows.forEach(row => {
                    let visible = true;
                    inputs.forEach(input => {
                        const columnIndex = parseInt(input.dataset.column);
                        const filterValue = input.value.toLowerCase();
                        const cellText = row.cells[columnIndex].innerText.toLowerCase();
                        if (filterValue && !cellText.includes(filterValue)) {
                            visible = false;
                        }
                    });
                    row.style.display = visible ? "" : "none";
                });
            }

            // 🔸 Resetar todos os filtros
            function clearFilters() {
                const inputs = table.querySelectorAll("thead input");
                inputs.forEach(input => input.value = "");
                filterTable();
            }
        }
        document.addEventListener("DOMContentLoaded", function () {
            init_table("table-config");
            init_table("table-data");
        });
    </script>
{% endblock extra_script %}
{% block extra_css %}
    <style>
        .w20p{
            width: 20%;
        }
        .w25p{
            width: 25%;
        }
        .w35p{
            width: 35%;
        }
    </style>
{% endblock extra_css %}
{#
3PJJNTU34HT
#}

{% extends "base-fixed" %}
{% from "macros/pagination.html" import render_pagination %}
{% from "macros/navigation.html" import go_back %}
{% block title %}
    Reservas Avulsas (temporárias)
{% endblock title %}
{% block content %}
    <div class="btn-group">
        <a href="{{ url_for("default.home") }}" class="btn btn-default">
            <span class="glyphicon glyphicon-home"></span> Início
        </a>
        <a href="{{ url_for("usuario.menu_reservas_usuario") }}"
           class="btn btn-primary">
            <span class="glyphicon glyphicon-list"></span> Menu
        </a>
    </div>
    <h4 class="text-muted">Agora: {{ datetime|datahora }}</h4>
    <div class="panel panel-info">
        <!-- HEADER -->
        <div class="panel-heading">
            <strong>Reservas Avulsas</strong>
        </div>
        <!-- FILTROS -->
        <div class="panel-body filtro">
            <div class="well well-sm">
                <form method="get">
                    <div class="row">
                        <!-- SEMESTRE -->
                        <div class="col-sm-4 col-md-3">
                            <div class="form-group">
                                <label>Semestre</label>
                                <select name="semestre"
                                        class="form-control input-sm"
                                        onchange="this.form.submit()">
                                    <option value="">Todos</option>
                                    {% for s in semestres %}
                                        <option value="{{ s.id_semestre }}"
                                                {% if s.id_semestre == request.args.get('semestre')|int %}selected{% endif %}>
                                            {{ s.nome_semestre }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <!-- FUTURO FILTRO LAB -->
                        <div class="col-sm-4 col-md-3">
                            <div class="form-group">
                                <label>Laboratório</label>
                                <select name="lab"
                                        class="form-control input-sm"
                                        onchange="this.form.submit()">
                                    <option value="">Todos</option>
                                    {% for lab in laboratorios %}
                                        <option value="{{ lab.id_local }}"
                                                {% if request.args.get('lab')|int == lab.id_local %}selected{% endif %}>
                                            {{ lab.nome_local }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <!-- FILTRO semanas-->
                        <div class="col-sm-4 col-md-3">
                            <div class="form-group">
                                <label>dia da semana</label>
                                <select name="semana"
                                        class="form-control input-sm"
                                        onchange="this.form.submit()">
                                    <option value="">Todos</option>
                                    {% for semana in semanas %}
                                        <option value="{{ semana.id_semana }}"
                                                {% if request.args.get('semana')|int == semana.id_semana %}selected{% endif %}>
                                            {{ semana.nome_semana }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <!-- FILTRO finalidade -->
                        <div class="col-sm-4 col-md-3">
                            <div class="form-group">
                                <label>Finalidade da Reserva</label>
                                <select name="finalidade"
                                        class="form-control input-sm"
                                        onchange="this.form.submit()">
                                    <option value="">Todos</option>
                                    {% for tr in TipoReserva %}
                                        <option value="{{ tr.value }}"
                                                {% if request.args.get('finalidade') == tr.value %}selected{% endif %}>
                                            {{ tr.value }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    {% if user.perm|has_flag(ADMIN) %}
                        <div class="form-section">Filtros administrativos</div>
                        <div class="row">
                            <!-- RESPONSAVEL -->
                            <div class="col-sm-4 col-md-3">
                                <div class="form-group">
                                    <label>Responsável</label>
                                    <select name="responsavel"
                                            class="form-control input-sm"
                                            onchange="this.form.submit()">
                                        <option value="">Todos</option>
                                        {% for p in pessoas %}
                                            <option value="{{ p.id_pessoa }}"
                                                    {% if request.args.get('responsavel')|int == p.id_pessoa %}selected{% endif %}>
                                                {{ p.nome_pessoa }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <!-- RESPONSAVEL ESPECIAL -->
                            <div class="col-sm-4 col-md-3">
                                <div class="form-group">
                                    <label>Resp. especial</label>
                                    <select name="responsavel_especial"
                                            class="form-control input-sm"
                                            onchange="this.form.submit()">
                                        <option value="">Todos</option>
                                        {% for ue in usuarios_especiais %}
                                            <option value="{{ ue.id_usuario_especial }}"
                                                    {% if request.args.get('responsavel_especial')|int == ue.id_usuario_especial %}selected{% endif %}>
                                                {{ ue.nome_usuario_especial }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>
        <!-- TABELA -->
        <div class="panel-body">
            {% if reservas_temporarias %}
                <div class="table-responsive">
                    <table class="table table-striped table-condensed table-bordered table-hover">
                        <thead>
                            <tr class="info">
                                {% if user.perm|has_flag(ADMIN) %}<th>Resp</th>{% endif %}
                                <th>Lab</th>
                                <th>Período</th>
                                <th>Dia / Horário</th>
                                <th>Tipo</th>
                                <th class="col-action">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in reservas_temporarias %}
                                <tr class="linha-click"
                                    data-info-url="{{ url_for('usuario.get_info_reserva', tipo_reserva='temporaria', id_reserva=r.id_reserva_temporaria) }}">
                                    {% if user.perm|has_flag(ADMIN) %}
                                        <td title="{{ get_responsavel_reserva(r) }}">{{ get_responsavel_reserva(r) |truncate(12) }}</td>
                                    {% endif %}
                                    <td>{{ r.local.nome_local }}</td>
                                    <td>
                                        {{ r.inicio_reserva|data }}
                                        <br>
                                        <small class="text-muted">até {{ r.fim_reserva|data }}</small>
                                    </td>
                                    <td>
                                        {{ r.aula_ativa.dia_da_semana.nome_semana }}
                                        <br>
                                        <small class="text-muted">
                                            {{ r.aula_ativa.aula.horario_inicio|hora }}
                                            –
                                            {{ r.aula_ativa.aula.horario_fim|hora }}
                                        </small>
                                    </td>
                                    <td>{{ r.finalidade_reserva.value }}</td>
                                    <!-- AÇÕES -->
                                    <td class="acoes">
                                        <div class="btn-group">
                                            <button type="button"
                                                    class="btn btn-default btn-xs dropdown-toggle"
                                                    data-toggle="dropdown">
                                                <span class="glyphicon glyphicon-cog"></span>
                                            </button>
                                            <ul class="dropdown-menu dropdown-menu-right">
                                                <li>
                                                    <a class="btn-detalhes"
                                                       data-toggle="modal"
                                                       data-target="#modalDetalhes"
                                                       data-info-url="{{ url_for('usuario.get_info_reserva', tipo_reserva='temporaria', id_reserva=r.id_reserva_temporaria) }}">
                                                        Detalhes
                                                    </a>
                                                </li>
                                                <li>
                                                    <a class="btn-editar"
                                                       data-toggle="modal"
                                                       data-target="#modalEditar"
                                                       data-info-url="{{ url_for('usuario.get_info_reserva', tipo_reserva='temporaria', id_reserva=r.id_reserva_temporaria) }}">
                                                        Editar
                                                    </a>
                                                </li>
                                                <li class="divider"></li>
                                                <li>
                                                    <a class="btn-cancelar text-danger"
                                                       data-toggle="modal"
                                                       data-target="#modalCancelar"
                                                       data-info-url="{{ url_for('usuario.get_info_reserva', tipo_reserva='temporaria', id_reserva=r.id_reserva_temporaria) }}">
                                                        Cancelar
                                                    </a>
                                                </li>
                                            </ul>
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {{ render_pagination(pagination, 'usuario.gerenciar_reserva_temporaria', args_extras) }}
                {% include "usuario/modal_cancelar.html" %}
                {% include "usuario/modal_editar.html" %}
                {% include "usuario/modal_detalhes.html" %}
            {% else %}
                <div class="alert alert-warning">Nenhuma reserva encontrada.</div>
            {% endif %}
        </div>
    </div>
{% endblock content %}
{% block extra_script %}
    <script>
$(document).on('click','.linha-click',function(e){
    if($(e.target).closest('.btn-group').length) return;
    let url = $(this).data('info-url');
    $('.btn-detalhes[data-info-url="'+url+'"]').click();
});

$(document).on('click','.acoes',function(e){
    e.stopPropagation();
});

$(document).on('click','.btn-cancelar',function(){
    $.getJSON($(this).data('info-url'), function(data){
        $('#modalCLocal').text(data.local);
        $('#modalCSemana').text(data.semana);
        $('#modalCPeriodo').text(data.periodo);
        $('#modalCHorario').text(data.horario);
        $('#formCancelar').attr('action', data.cancel_url);
    });
});

$(document).on('click','.btn-editar',function(){
    $.getJSON($(this).data('info-url'), function(data){
        $('#modalELocal').text(data.local);
        $('#modalESemana').text(data.semana);
        $('#modalEPeriodo').text(data.periodo);
        $('#modalEHorario').text(data.horario);
        $('#modalEObservacao').val(data.observacao);
        $('#modalETipoReserva').val(data.finalidadereserva);
        $('#formEditar').attr('action', data.editar_url);

        {% if user.perm|has_flag(ADMIN) %}
        $('#modalEResponsavel').val(data.responsavel);
        $('#modalEResponsavelEspecial').val(data.responsavel_especial);
        {% endif %}
    });
});

$(document).on('click','.btn-detalhes',function(){
    $.getJSON($(this).data('info-url'), function(data){
        $('#modalDLocal').text(data.local);
        $('#modalDSemana').text(data.semana);
        $('#modalDPeriodo').text(data.periodo);
        $('#modalDHorario').text(data.horario);
        $('#modalDObservacao').text(data.observacao || "sem observações");
    });
});

    </script>
{% endblock extra_script %}
{% block extra_css %}
    <style>
        .table-responsive { overflow: visible; }
        .filtro { padding-bottom:0 }
        .filtro_all { margin-left:15px }
        .col-action { width:80px }
        .form-section{
            margin:20px 0 10px;
            font-size:12px;
            text-transform:uppercase;
            color:#777;
            border-bottom:1px solid #ddd;
        }
    </style>
{% endblock extra_css %}

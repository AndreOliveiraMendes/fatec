{% extends "base-fixed" %}
{% from "macros/pagination.html" import render_pagination %}
{% from "macros/navigation.html" import go_back %}

{% block title %}
Reservas Avulsas (temporárias)
{% endblock title %}

{% block content %}

<div class="btn-group">
    <a href="{{ url_for('default.home') }}" class="btn btn-default">
        <span class="glyphicon glyphicon-home"></span> Início
    </a>
    <a href="{{ url_for('usuario.menu_reservas_usuario') }}" class="btn btn-primary">
        <span class="glyphicon glyphicon-list"></span> Menu
    </a>
</div>

<h4 class="text-muted">Agora: {{ datetime|datahora }}</h4>

<div class="panel panel-info">

    <!-- HEADER -->
    <div class="panel-heading">
        <strong>Reservas Avulsas</strong>
    </div>

    <!-- FILTROS -->
    <div class="panel-body filtro">
        <div class="well well-sm">
            <form method="get" class="form-inline">

                <div class="form-group">
                    <label>Dia:</label>
                    <input type="date"
                           name="dia"
                           class="form-control input-sm"
                           value="{{ request.args.get('dia','') }}"
                           onchange="this.form.submit()">
                </div>

                {% if user.perm|has_flag(ADMIN) %}
                <div class="checkbox chk-all">
                    <label>
                        <input type="checkbox"
                               name="all"
                               onchange="this.form.submit()"
                               {% if 'all' in request.args %}checked{% endif %}>
                        Mostrar todos
                    </label>
                </div>
                {% endif %}

            </form>
        </div>
    </div>

    <!-- TABELA -->
    <div class="panel-body">

    {% if reservas_temporarias %}
    <div class="table-responsive">
        <table class="table table-striped table-condensed table-bordered table-hover">

            <thead>
                <tr class="info">
                    {% if all %}<th>Resp</th>{% endif %}
                    <th>Lab</th>
                    <th>Período</th>
                    <th>Dia / Horário</th>
                    <th>Tipo</th>
                    <th class="col-action">Ações</th>
                </tr>
            </thead>

            <tbody>
            {% for r in reservas_temporarias %}
            <tr class="linha-click"
                data-info-url="{{ url_for('usuario.get_info_reserva', tipo_reserva='temporaria', id_reserva=r.id_reserva_temporaria) }}">

                {% if all %}
                <td title="{{ get_responsavel_reserva(r) }}">
                    {{ get_responsavel_reserva(r)|truncate(12) }}
                </td>
                {% endif %}

                <td>{{ r.local.nome_local }}</td>

                <td>
                    {{ r.inicio_reserva|data }}
                    <br>
                    <small class="text-muted">
                        até {{ r.fim_reserva|data }}
                    </small>
                </td>

                <td>
                    {{ r.aula_ativa.dia_da_semana.nome_semana }}
                    <br>
                    <small class="text-muted">
                        {{ r.aula_ativa.aula.horario_inicio|hora }}
                        –
                        {{ r.aula_ativa.aula.horario_fim|hora }}
                    </small>
                </td>

                <td>{{ r.finalidade_reserva.value }}</td>

                <!-- AÇÕES -->
                <td class="acoes">
                    <div class="btn-group">

                        <button type="button"
                                class="btn btn-default btn-xs dropdown-toggle"
                                data-toggle="dropdown">
                            <span class="glyphicon glyphicon-cog"></span>
                        </button>

                        <ul class="dropdown-menu dropdown-menu-right">

                            <li>
                                <a class="btn-detalhes"
                                   data-toggle="modal"
                                   data-target="#modalDetalhes"
                                   data-info-url="{{ url_for('usuario.get_info_reserva', tipo_reserva='temporaria', id_reserva=r.id_reserva_temporaria) }}">
                                   Detalhes
                                </a>
                            </li>

                            <li>
                                <a class="btn-editar"
                                   data-toggle="modal"
                                   data-target="#modalEditar"
                                   data-info-url="{{ url_for('usuario.get_info_reserva', tipo_reserva='temporaria', id_reserva=r.id_reserva_temporaria) }}">
                                   Editar
                                </a>
                            </li>

                            <li class="divider"></li>

                            <li>
                                <a class="btn-cancelar text-danger"
                                   data-toggle="modal"
                                   data-target="#modalCancelar"
                                   data-info-url="{{ url_for('usuario.get_info_reserva', tipo_reserva='temporaria', id_reserva=r.id_reserva_temporaria) }}">
                                   Cancelar
                                </a>
                            </li>

                        </ul>
                    </div>
                </td>

            </tr>
            {% endfor %}
            </tbody>

        </table>
    </div>

    {{ render_pagination(pagination, 'usuario.gerenciar_reserva_temporaria', args_extras) }}

    {% include "usuario/modal_cancelar.html" %}
    {% include "usuario/modal_editar.html" %}
    {% include "usuario/modal_detalhes.html" %}

    {% else %}
        <div class="alert alert-warning">Nenhuma reserva encontrada.</div>
    {% endif %}

    </div>
</div>

{% endblock content %}

{% block extra_script %}
<script>

$(document).on('click','.linha-click',function(e){
    if($(e.target).closest('.btn-group').length) return;
    let url = $(this).data('info-url');
    $('.btn-detalhes[data-info-url="'+url+'"]').click();
});

$(document).on('click','.acoes',function(e){
    e.stopPropagation();
});

$(document).on('click','.btn-cancelar',function(){
    $.getJSON($(this).data('info-url'), function(data){
        $('#modalCLocal').text(data.local);
        $('#modalCSemana').text(data.semana);
        $('#modalCPeriodo').text(data.periodo);
        $('#modalCHorario').text(data.horario);
        $('#formCancelar').attr('action', data.cancel_url);
    });
});

$(document).on('click','.btn-editar',function(){
    $.getJSON($(this).data('info-url'), function(data){
        $('#modalELocal').text(data.local);
        $('#modalESemana').text(data.semana);
        $('#modalEPeriodo').text(data.periodo);
        $('#modalEHorario').text(data.horario);
        $('#modalEObservacao').val(data.observacao);
        $('#modalETipoReserva').val(data.finalidadereserva);
        $('#formEditar').attr('action', data.editar_url);

        {% if user.perm|has_flag(ADMIN) %}
        $('#modalEResponsavel').val(data.responsavel);
        $('#modalEResponsavelEspecial').val(data.responsavel_especial);
        {% endif %}
    });
});

$(document).on('click','.btn-detalhes',function(){
    $.getJSON($(this).data('info-url'), function(data){
        $('#modalDLocal').text(data.local);
        $('#modalDSemana').text(data.semana);
        $('#modalDPeriodo').text(data.periodo);
        $('#modalDHorario').text(data.horario);
        $('#modalDObservacao').text(data.observacao || "sem observações");
    });
});

</script>
{% endblock extra_script %}

{% block extra_css %}
<style>
.table-responsive { overflow: visible; }
.filtro { padding-bottom:0 }
.chk-all { margin-left:15px }
.col-action { width:80px }
</style>
{% endblock extra_css %}

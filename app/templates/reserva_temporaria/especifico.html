{% extends "base-fluid" %}
{% from "macros/form.html" import action_buttons %}
{% from "macros/navigation.html" import go_back %}
{% block title %}
    efetuar reserva
{% endblock title %}
{% block content %}
    {{ generate_reserva_head(locais, 'contador', turno, local, inicio=inicio, fim=fim) }}
    <div class="center-content">
        <div class="btn-group">
            {{ go_back(contador) }}
            <a href="{{ url_for("default.home") }}" class="btn btn-default">
                <span class="glyphicon glyphicon-home"></span> Início
            </a>
        </div>
        <h3>
            <strong>Reserva Avulsa</strong>: {{ inicio|data }} - {{ fim|data }} — <strong>Turno:</strong>  {{ turno.nome_turno if turno else 'Livre' }}
        </h3>
        <p>
            <strong>Período:</strong> {{ inicio|data }} a {{ fim|data }}
            {% if turno %}
                <br>
                <strong>Horário:</strong> {{ turno.horario_inicio|hora }} às {{ turno.horario_fim|hora }}
            {% else %}
                <br>
                <strong>Horário:</strong> 00:00 às 23:59
            {% endif %}
            <br>
            <strong>Horarios disponiveis:</strong> {{ aulas|length }} <strong>Local:</strong> {{ local.nome_local }}
            <br>
            <strong>Especificação:</strong> {{ local.descrição }}
        </p>
        <form class="form-group"
              role="form"
              action="{{ url_for('reservas_temporarias.efetuar_reserva', inicio=inicio, fim=fim) }}"
              id="reserva"
              method="post">
            <div class="table-responsive tabela-wrapper">
                <table class="table table-bordered table-striped table-hover tabela-reserva">
                    <thead>
                        <tr>
                            <th class="col-fixa">Dias</th>
                            {% for aula in head %}<th>{{ aula[0]|hora }} - {{ aula[1]|hora }}</th>{% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for dia in dias %}
                            <tr>
                                <td class="col-fixa">{{ dia['dia'] }} ({{ dia['semana'] }})</td>
                                {% for info in dia['infos'] %}
                                    <td
                                        data-aula="{{ info.id_aula_ativa }}"
                                        data-local="{{ local.id_local }}"
                                        data-dia="{{ dia['dia'] }}"
                                        data-id-reserva="">
                                        <input type="checkbox"
                                            class="form-check-input"
                                            name="reserva[{{ local.id_local }},{{ info.id_aula_ativa }},{{ dia['dia'] }}]">
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="form-group">
                <label for="tipo_reserva">Destinação da Reserva:</label>
                <select id="tipo_reserva" class="form-control" name="tipo_reserva" required>
                    <option value="">Selecione a finalidade da reserva</option>
                    {% for fr in finalidade_reserva %}<option value="{{ fr.value }}">{{ fr.value }}</option>{% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="observacoes">Observações:</label>
                <textarea id="observacoes"
                          name="observacoes"
                          class="form-control"
                          placeholder="Insira observações relevantes (exemplo: softwares necessários)"
                          rows="6"
                          cols="60"></textarea>
            </div>
            <div class="form-group">
                <label for="descricao">Descrição:</label>
                <input type="text"
                       maxlength="100"
                       id="descricao"
                       name="descricao"
                       class="form-control"
                       placeholder="insira a descrição da reserva">
            </div>
            {% if user and user.perm|has_flag(ADMIN) %}
                <div class="form-group">
                    <label for="responsavel">Responsavel:</label>
                    <select id="responsavel" name="responsavel" class="form-control">
                        <option value="">Selecione o responsavel pela reserva</option>
                        {% for r in responsavel %}
                            <option value="{{ r.id_pessoa }}">({{ r.id_pessoa }}) {{ r.nome_pessoa }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="responsavel_especial">Responsavel especial:</label>
                    <select id="responsavel_especial"
                            name="responsavel_especial"
                            class="form-control">
                        <option value="">Selecione o responsavel especial pela reserva</option>
                        {% for r in responsavel_especial %}
                            <option value="{{ r.id_usuario_especial }}">({{ r.id_usuario_especial }}) {{ r.nome_usuario_especial }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}
            {{ action_buttons('inserir', show_voltar=False, label='') }}
        </form>
    </div>
    {% if user and user.perm|has_flag(ADMIN) %}
        {% include "reserva_temporaria/modal_reserva_editar.html" %}
        {% include "reserva_temporaria/modal_reserva_excluir.html" %}
    {% endif %}
    {% include "reserva_temporaria/modal_reserva_fixa_info.html" %}
{% endblock content %}
{% block extra_script %}
    <script>{{ adjust_head_fix() }}</script>
    <!-- Script para mostrar/ocultar campo de descrição baseado na finalidade da reserva -->
    <script>
    document.getElementById('finalidade_reserva').addEventListener('change', function() {
        var value = this.value;
        var descricao = document.getElementById('descricao');
        var descricaoWrapper = descricao.parentElement;

        if(value == 'Curso'){
            descricao.disabled = false;
            descricaoWrapper.style.display = 'block';
        } else {
            descricao.disabled = true;
            descricaoWrapper.style.display = 'none';
        }
    });

    window.addEventListener('load', function() {
        document.getElementById('finalidade_reserva').dispatchEvent(new Event('change'));
    });
    </script>
    <!-- Script para atualizar a tabela -->
    <script>
    document.addEventListener("DOMContentLoaded", function () {

        const baseUrlFixa = {{ url_for(
            'api_reservas.get_reserva_indirect',
            tipo_reserva=0,
            dia=fake_data,
            id_local=0,
            id_aula=0
        )|tojson }};

        const baseUrlTemporaria = {{ url_for(
            'api_reservas.get_reserva_indirect',
            tipo_reserva=1,
            dia=fake_data,
            id_local=0,
            id_aula=0
        )|tojson }};

        function buildReservaFixaUrl(dia, localId, aulaId) {
            return baseUrlFixa.replace('2000-01-01/0/0', `/${dia}/${localId}/${aulaId}`);
        }

        function buildReservaTemporariaUrl(dia, localId, aulaId) {
            return baseUrlTemporaria.replace('2000-01-01/0/0', `/${dia}/${localId}/${aulaId}`);
        }

        // função para atualizar o status das reservas na tabela
        async function atualizarReservas(){
            document.querySelectorAll('.tabela-reserva td[data-aula]').forEach(async td => {
                const dia = td.dataset.dia;
                const localId = td.dataset.local;
                const aulaId = td.dataset.aula;
                
                const url = buildReservaTemporariaUrl(dia, localId, aulaId);

                // Primeiro verifica a reserva temporária
                try {
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.reservado) {
                        td.classList.add('reservado');
                        td.classList.remove('livre');
                        td.dataset.idReserva = data.id_reserva;

                        const checkbox = td.querySelector('input[type="checkbox"]');
                        if (checkbox) checkbox.remove();

                        const firstName = data.responsavel?.split(' ')[0] || 'Reservado';
                        td.textContent = firstName;
                        td.title = data.responsavel || '';
                    } else {
                        // Caso não esteja reservado, restaurar checkbox se não tiver
                        td.classList.remove('reservado');
                        td.classList.add('livre');
                        td.dataset.idReserva = '';
                        if (!td.querySelector('input')) {
                            td.innerHTML = `<input type="checkbox" class="form-check-input" name="reserva[${localId},${aulaId},${dia}]">`;
                        }
                        td.dataset.idReserva = '';
                        td.title = '';
                    }
                } catch (err) {
                    console.error(`Erro ao verificar reserva para o dia ${dia} local ${localId} e aula ${aulaId}:`, err);
                }
            });

            // Agora verifica as reservas fixas
            document.querySelectorAll('.tabela-reserva td[data-aula]').forEach(async td => {
                const dia = td.dataset.dia;
                const localId = td.dataset.local;
                const aulaId = td.dataset.aula;
                const url = buildReservaFixaUrl(dia, localId, aulaId);

                try {
                    const response = await fetch(url);
                    const data = await response.json();

                    if (data.reservado){
                        td.classList.add('reservado-fixo');
                        td.dataset.idReservaFixa = data.id_reserva;
                    } else {
                        td.classList.remove('reservado-fixo');
                        td.dataset.idReservaFixa = '';
                    }
                } catch (err) {
                    console.error(`Erro ao verificar reserva fixa para o dia ${dia} local ${localId} e aula ${aulaId}:`, err);
                }
            });
        }

        // Atualiza a cada 60 segundos (60000 ms)
        atualizarReservas(); // primeira chamada imediata
        setInterval(atualizarReservas, 60000);
    });
    </script>
    {% if user and user.perm|has_flag(ADMIN) %}
        <script src="{{ url_for('static', filename='js/reserva_temporaria_modal.js') }}"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                document.addEventListener("click", function (e) {

                    // Se clicou diretamente no checkbox, deixa passar
                    if (e.target.matches('input[type="checkbox"]')) {
                        const td = e.target.closest("td.reservado-fixo");
                        const checkbox = e.target;
                        if (td && checkbox.checked) {
                            alert("⚠️ Este horário possui uma reserva fixa, pressione ctrl + no quadrado (fora da check box) para ver mais detalhes");
                        }
                        return; // NÃO bloqueia
                    }

                    const td = e.target.closest("td.reservado, td.reservado-fixo");
                    if (!td) return;

                    const altPressed = e.altKey;
                    const ctrlPressed = e.ctrlKey;
                    const id = td.dataset.idReserva;

                    const url = {{ url_for('api_reservas.get_reserva_info', tipo_reserva=1, id_reserva='0')|tojson }};
                    const url_delete = {{ url_for('api_reservas.delete_reserva', tipo_reserva=1, id_reserva='0')|tojson }};
                    const url_edit = {{ url_for('api_reservas.update_reserva', tipo_reserva=1, id_reserva='0')|tojson }};

                    const id_fixa = td.dataset.idReservaFixa;
                    const url_info = {{ url_for('api_reservas.get_reserva_info', tipo_reserva=0, id_reserva='0')|tojson }};

                    if (td.classList.contains('reservado')) {

                        fetch(url.replace(/0$/, id))
                            .then(r => r.json())
                            .then(data => {
                                if (altPressed) {
                                    DeleteData(data, url_delete.replace(/0$/, id));
                                } else if (ctrlPressed && id_fixa) {
                                    openInfoModal(url_info.replace(/0$/, id_fixa));
                                } else {
                                    openReservaModal(data, url_edit.replace(/0$/, id));
                                }
                            })
                            .catch(err => {
                                alert("Erro ao carregar reserva devido a: " + err);
                            });

                    } else {
                        if (ctrlPressed && id_fixa) {
                            openInfoModal(url_info.replace(/0$/, id_fixa));
                        }
                    }

                });
            });
        </script>
    {% endif %}
{% endblock extra_script %}

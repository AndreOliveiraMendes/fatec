{% extends "base-fluid" %}
{% from "macros/form.html" import action_buttons %}
{% from "macros/navigation.html" import go_back %}
{% block title %}
    efetuar reserva
{% endblock title %}
{% block content %}
    {{ generate_reserva_head(locais, 'contador', turno, local, inicio=inicio, fim=fim) }}
    <div class="center-content">
        <div class="btn-group">
            {{ go_back(contador) }}
            <a href="{{ url_for('default.home') }}" class="btn btn-default">
                <span class="glyphicon glyphicon-home"></span> Início
            </a>
        </div>
        <h3>
            <strong>Reserva Avulsa</strong>: {{ inicio|data }} - {{ fim|data }} — <strong>Turno:</strong>  {{ turno.nome_turno if turno else 'Livre' }}
        </h3>
        <p>
            <strong>Período:</strong> {{ inicio|data }} a {{ fim|data }}
            {% if turno %}
                <br>
                <strong>Horário:</strong> {{ turno.horario_inicio|hora }} às {{ turno.horario_fim|hora }}
            {% else %}
                <br>
                <strong>Horário:</strong> 00:00 às 23:59
            {% endif %}
            <br>
            <strong>Horarios disponiveis:</strong> {{ aulas|length }} <strong>Local:</strong> {{ local.nome_local }}
            <br>
            <strong>Especificação:</strong> {{ local.descrição }}
        </p>
        <form class="form-group"
              role="form"
              action="{{ url_for('reservas_temporarias.efetuar_reserva', inicio=inicio, fim=fim) }}"
              id="reserva"
              method="post">
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover tabela-reserva">
                    <thead>
                        <tr class="information">
                            <th>Dias</th>
                            {% for aula in aulas %}<th>{{ aula[0]|hora }} - {{ aula[1]|hora }}</th>{% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for dia in dias %}
                            <tr>
                                <td>{{ dia['dia'] }} ({{ dia['semana'] }})</td>
                                {% for info in dia['infos'] %}
                                    {% if info %}
                                        {% set reservado = helper[(local.id_local, info.id_aula_ativa, dia['dia'])] %}
                                        {% if reservado %}
                                            <td class="reservado" title="{{ reservado }}">
                                                <span class="sr-only">Reservado</span>
                                                <input type="checkbox"
                                                       class="form-check-input checkbox-danger"
                                                       title="{{ reservado }}"
                                                       name="reserva[{{ local.id_local }},{{ info.id_aula_ativa }},{{ dia['dia'] }}]"
                                                       disabled>
                                            </td>
                                        {% else %}
                                            <td>
                                                <input type="checkbox"
                                                       class="form-check-input checkbox-danger"
                                                       name="reserva[{{ local.id_local }},{{ info.id_aula_ativa }},{{ dia['dia'] }}]">
                                            </td>
                                        {% endif %}
                                    {% else %}
                                        <td>-</td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="form-group">
                <label for="tipo_reserva">Destinação da Reserva:</label>
                <select id="tipo_reserva" class="form-control" name="tipo_reserva" required>
                    <option value="">Selecione a finalidade da reserva</option>
                    {% for fr in finalidade_reserva %}<option value="{{ fr.value }}">{{ fr.value }}</option>{% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="observacoes">Observações:</label>
                <textarea id="observacoes"
                          name="observacoes"
                          class="form-control"
                          placeholder="Insira observações relevantes (exemplo: softwares necessários)"
                          rows="6"
                          cols="60"></textarea>
            </div>
            <div class="form-group">
                <label for="descricao">Descrição:</label>
                <input type="text"
                       maxlength="100"
                       id="descricao"
                       name="descricao"
                       class="form-control"
                       placeholder="insira a descrição da reserva">
            </div>
            {% if user and user.perm|has_flag(ADMIN) %}
                <div class="form-group">
                    <label for="responsavel">Responsavel:</label>
                    <select id="responsavel" name="responsavel" class="form-control">
                        <option value="">Selecione o responsavel pela reserva</option>
                        {% for r in responsavel %}
                            <option value="{{ r.id_pessoa }}">({{ r.id_pessoa }}) {{ r.nome_pessoa }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="responsavel_especial">Responsavel especial:</label>
                    <select id="responsavel_especial"
                            name="responsavel_especial"
                            class="form-control">
                        <option value="">Selecione o responsavel especial pela reserva</option>
                        {% for r in responsavel_especial %}
                            <option value="{{ r.id_usuario_especial }}">({{ r.id_usuario_especial }}) {{ r.nome_usuario_especial }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}
            {{ action_buttons('inserir', show_voltar=False, label='') }}
        </form>
    </div>
{% endblock content %}
{% block extra_script %}
    <script>{{ adjust_head_fix() }}</script>
    <script>
    document.getElementById('finalidade_reserva').addEventListener('change', function() {
        var value = this.value;
        var descricao = document.getElementById('descricao');
        var descricaoWrapper = descricao.parentElement;

        if(value == 'Curso'){
            descricao.disabled = false;
            descricaoWrapper.style.display = 'block';
        } else {
            descricao.disabled = true;
            descricaoWrapper.style.display = 'none';
        }
    });

    window.addEventListener('load', function() {
        document.getElementById('finalidade_reserva').dispatchEvent(new Event('change'));
    });
    </script>
{% endblock extra_script %}

{% extends "base-fixed" %}
{% block title %}
    Comandos Remotos
{% endblock title %}
{% block content %}
    {{ generate_situacao_head("comandos") }}
    <div class="text-right margin-bottom-10">
        <button id="btnRefresh" class="btn btn-sm btn-default">üîÑ Recarregar</button>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">
            <h3 class="panel-title">üíª Comandos por Laborat√≥rio</h3>
        </div>
        <div class="panel-body">
            <div id="labsContainer" class="table-responsive">
                <p class="text-muted">Carregando laborat√≥rios...</p>
            </div>
        </div>
    </div>
    <!-- Painel extra para comandos globais -->
    <div class="panel panel-info">
        <div class="panel-heading">
            <h3 class="panel-title">‚öôÔ∏è Comandos Gerais (sem v√≠nculo com laborat√≥rio)</h3>
        </div>
        <div class="panel-body">
            <div id="globalCmdsContainer">
                <p class="text-muted">Carregando comandos...</p>
            </div>
        </div>
    </div>
    <!-- modal de comandos -->
    <div class="modal fade" id="paramModal" tabindex="-1" role="dialog">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-info">
                    <button type="button" class="close" data-dismiss="modal">√ó</button>
                    <h4 class="modal-title">Executar Comando</h4>
                </div>
                <div class="modal-body">
                    <form id="paramForm">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="btnExecutar">Executar</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Modal de Resultado da Execu√ß√£o -->
    <div class="modal fade" id="resultModal" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h4 class="modal-title">üñ•Ô∏è Resultado da Execu√ß√£o</h4>
                </div>
                <div class="modal-body">
                    <div id="stdoutPanel" class="well well-sm command-output stdout">
                        <strong>Sa√≠da (stdout):</strong>
                        <div id="stdoutContent" class="margin-top-5"></div>
                    </div>
                    <div id="stderrPanel" class="well well-sm command-output stderr">
                        <strong>Erros (stderr):</strong>
                        <div id="stderrContent" class="margin-top-5"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-default" data-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    <div id="spinnerOverlay" class="spinner-overlay hide">
        <div class="spinner"></div>
        <p class="text-white">Executando comando...</p>
    </div>
{% endblock content %}
{% block extra_script %}
    <script>
        (function() {
            const labsContainer = document.getElementById('labsContainer');
            const globalCmdsContainer = document.getElementById('globalCmdsContainer');
            let comandosGlobais = []; // para uso na execu√ß√£o

            const LABS_URL = "{{ url_for('api.api_get_laboratorios') }}";
            const COMMANDS_URL = "{{ url_for('api_commands.api_list_commands') }}"; // endpoint de comandos

            async function carregarDados() {
                try {
                    const [labsResp, cmdsResp] = await Promise.all([
                        fetch(LABS_URL),
                        fetch(COMMANDS_URL)
                    ]);

                    const labs = await labsResp.json();
                    var comandos = await cmdsResp.json();

                    //filtra apenas comandos ativos
                    comandos = comandos.filter(c => c.active);

                    comandosGlobais = comandos;

                    renderTabelaLabs(labs, comandos);
                    renderTabelaGlobais(comandos);
                } catch (e) {
                    console.error(e);
                    labsContainer.innerHTML = '<p class="text-danger">Erro ao carregar dados.</p>';
                    globalCmdsContainer.innerHTML = '<p class="text-danger">Erro ao carregar dados.</p>';
                }
            }

            // --- Tabela principal (laborat√≥rios)
            function renderTabelaLabs(labs, comandos) {
                if (!labs.length) {
                    labsContainer.innerHTML = '<p class="text-muted">Nenhum laborat√≥rio encontrado.</p>';
                    return;
                }

                const tabela = document.createElement('table');
                tabela.className = 'table table-bordered table-striped table-condensed';

                tabela.innerHTML = `
                    <thead>
                        <tr class="info">
                            <th style="width: 200px;">Laborat√≥rio</th>
                            <th colspan="4" class="text-center">Comandos dispon√≠veis</th>
                            <th>ver mais...</th>
                        </tr>
                    </thead>
                `;

                const tbody = document.createElement('tbody');

                labs.forEach(lab => {
                    const linha = document.createElement('tr');
                    const colLab = document.createElement('td');
                    colLab.innerHTML = `
                        <strong>${lab.nome}</strong><br>
                        <small class="text-muted">#${lab.id}</small><br>
                        <span class="label label-${lab.disponivel === "Disponivel" ? "success" : "default"}">
                            ${lab.disponivel}
                        </span>
                    `;
                    linha.appendChild(colLab);

                    const cmdsLab = comandos.filter(cmd =>
                        cmd.params.some(p =>
                            p.selection_type === 'auto' &&
                            Array.isArray(p.values) &&
                            p.values.some(v => v.lab_id === lab.id)
                        )
                    );

                    if (!cmdsLab.length) {
                        const td = document.createElement('td');
                        td.colSpan = 5;
                        td.className = 'text-center text-muted';
                        td.textContent = '‚Äî Nenhum comando autom√°tico associado ‚Äî';
                        linha.appendChild(td);
                    } else {
                        // filtra os primeiro 4 comandos
                        const cmdsLab4 = cmdsLab.slice(0, 4);

                        // cria c√©lulas para cada comando
                        cmdsLab4.forEach(cmd => {
                            const td = document.createElement('td');
                            td.innerHTML = `
                                <button class="btn btn-sm btn-primary btn-run" data-cmd-id="${cmd.id}" data-lab-id="${lab.id}">
                                    ‚öôÔ∏è ${cmd.name}
                                </button>
                            `;
                            linha.appendChild(td);
                        });

                        // completa at√© 4 celulas se necess√°rio
                        for (let i = cmdsLab4.length; i < 4; i++) {
                            linha.appendChild(document.createElement('td'));
                        }

                        // op√ß√£o "ver mais" (abre um mini modal com os comandos restantes)
                        const tdMais = document.createElement('td');
                        if (cmdsLab.length > 4) {
                            tdMais.innerHTML = `
                                <button class="btn btn-sm btn-info" data-toggle="modal" data-target="#moreCmdsModal${lab.id}">
                                    +${cmdsLab.length - 4} mais...
                                </button>

                                <!-- Modal de mais comandos -->
                                <div class="modal fade" id="moreCmdsModal${lab.id}" tabindex="-1" role="dialog">
                                    <div class="modal-dialog">
                                        <div class="modal-content">
                                            <div class="modal-header bg-info">
                                                <button type="button" class="close" data-dismiss="modal">√ó</button>
                                                <h4 class="modal-title">Comandos adicionais para ${lab.nome}</h4>
                                            </div>
                                            <div class="modal-body">
                                                ${cmdsLab.slice(4).map(cmd => `
                                                    <div class="margin-bottom-10">
                                                        <strong>${cmd.name}</strong><br>
                                                        <code>${cmd.template}</code><br>
                                                        <button class="btn btn-sm btn-primary btn-run" data-cmd-id="${cmd.id}" data-lab-id="${lab.id}">
                                                            ‚öôÔ∏è Executar
                                                        </button>
                                                    </div>
                                                `).join('')}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        } else {
                            tdMais.innerHTML = '<span class="text-muted">‚Äî</span>';
                        }
                        linha.appendChild(tdMais);
                    }

                    tbody.appendChild(linha);
                });

                tabela.appendChild(tbody);
                labsContainer.innerHTML = '';
                labsContainer.appendChild(tabela);

                // eventos de clique
                tabela.querySelectorAll('.btn-run').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const cmdId = e.target.dataset.cmdId;
                        const labId = e.target.dataset.labId;
                        executarComando(cmdId, labId);
                    });
                });
            }

            // --- Painel de comandos sem laborat√≥rio ---
            function renderTabelaGlobais(comandos) {
                const globais = comandos.filter(cmd => 
                    !cmd.params.some(p => 
                        p.selection_type === 'auto' && Array.isArray(p.values) && p.values.length
                    )
                );

                if (!globais.length) {
                    globalCmdsContainer.innerHTML = '<p class="text-muted">Nenhum comando global dispon√≠vel.</p>';
                    return;
                }

                const grid = document.createElement('div');
                grid.className = 'row';

                globais.forEach(cmd => {
                    const col = document.createElement('div');
                    col.className = 'col-sm-6 col-md-3';
                    col.innerHTML = `
                        <div class="panel panel-default">
                            <div class="panel-body text-center">
                                <h5><strong>${cmd.name}</strong></h5>
                                <code>${cmd.template}</code><br>
                                <button class="btn btn-sm btn-primary btn-run-global margin-top-5" data-cmd-id="${cmd.id}">
                                    ‚öôÔ∏è Executar
                                </button>
                            </div>
                        </div>
                    `;
                    grid.appendChild(col);
                });

                globalCmdsContainer.innerHTML = '';
                globalCmdsContainer.appendChild(grid);

                grid.querySelectorAll('.btn-run-global').forEach(btn => {
                    btn.addEventListener('click', e => {
                        const cmdId = e.target.dataset.cmdId;
                        executarComando(cmdId, null);
                    });
                });
            }

            // --- Execu√ß√£o ---
            function executarComando(cmdId, labId) {
                const cmd = comandosGlobais.find(c => c.id == cmdId); // salva comandosGlobais no escopo maior
                if (!cmd) return alert("Comando n√£o encontrado.");

                if (labId) {
                    const faltando = cmd.params.filter(p =>
                        p.selection_type === "auto" &&
                        (
                            !Array.isArray(p.values) ||
                            !p.values.some(v => v.lab_id === Number(labId))
                        )
                    );

                    if (faltando.length) {
                        alert(`‚ùå Par√¢metros autom√°ticos n√£o configurados para este laborat√≥rio:\n- ${faltando.map(f => f.alias || f.name).join("\n- ")}`);
                        return;
                    }
                }

                abrirModalParametros(cmd, labId);
            }
            function abrirModalParametros(cmd, labId) {
                const form = document.getElementById("paramForm");
                form.innerHTML = "";

                const paramsManuais = cmd.params.filter(p => p.selection_type === "manual");

                if (!paramsManuais.length) {
                    // sem par√¢metros manuais ‚Üí executar direto
                    executarComandoFinal(cmd, labId, {});
                    return;
                }

                paramsManuais.forEach(p => {
                    const grupo = document.createElement("div");
                    grupo.className = "form-group";
                    grupo.innerHTML = `<label>${p.alias || p.name}</label>`;

                    if (Array.isArray(p.values) && p.values.length > 0) {
                        const select = document.createElement("select");
                        select.className = "form-control";
                        select.name = p.name;
                        p.values.forEach(v => {
                            const opt = document.createElement("option");
                            opt.value = v;
                            opt.textContent = v;
                            select.appendChild(opt);
                        });
                        grupo.appendChild(select);
                    } else {
                        const input = document.createElement("input");
                        input.type = p.type === "int" ? "number" : p.type === "time" ? "time" : "text";
                        input.className = "form-control";
                        input.name = p.name;
                        grupo.appendChild(input);
                    }

                    form.appendChild(grupo);
                });

                const btnExec = document.getElementById("btnExecutar");
                btnExec.onclick = () => {
                    const dados = Object.fromEntries(new FormData(form).entries());
                    executarComandoFinal(cmd, labId, dados);
                    $("#paramModal").modal("hide");
                };

                $("#paramModal").modal("show");
            }
            function executarComandoFinal(cmd, labId, paramsManuais) {
                const paramsCompletos = {};
                const btn_run = document.querySelectorAll(".btn-run");
                const btn_run_global = document.querySelectorAll(".btn-run-global");
                const btn_refresh = document.getElementById("btnRefresh");
                // desativa bot√µes de execu√ß√£o
                btn_run.forEach(b => b.disabled = true);
                btn_run_global.forEach(b => b.disabled = true);
                btn_refresh.disabled = true;
                // mostra spinner
                document.getElementById("spinnerOverlay").classList.remove("hide");

                // juntar autom√°ticos
                cmd.params.forEach(p => {
                    if (p.selection_type === "auto" && labId) {
                        const val = p.values.find(v => v.lab_id === Number(labId));
                        if (val) paramsCompletos[p.name] = val.valor;
                    } else if (p.selection_type === "manual") {
                        paramsCompletos[p.name] = paramsManuais[p.name] || "";
                    }
                });

                const corpo = {
                    cmd_id: cmd.id,
                    lab_id: labId,
                    parametros: paramsCompletos
                };

                fetch("{{ url_for('api_commands.api_run_command') }}", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(corpo)
                })
                .then(r => r.json())
                .then(data => {
                    if (!data.success) {
                        alert(data.error || "Falha ao executar comando.");
                        return;
                    }

                    // preenche o modal com stdout/stderr
                    document.getElementById("stdoutContent").textContent =
                        data.stdout && data.stdout.trim() ? data.stdout.trim() : "(sem sa√≠da)";
                    document.getElementById("stderrContent").textContent =
                        data.stderr && data.stderr.trim() ? data.stderr.trim() : "(sem erros)";

                    // destaque visual se houve erro
                    const stderrPanel = document.getElementById("stderrPanel");
                    stderrPanel.style.borderLeft = data.stderr ? "5px solid #d9534f" : "5px solid #5cb85c";

                    $("#resultModal").modal("show");
                })
                .catch(err => {
                    console.error(err);
                    alert("‚ùå Erro ao executar comando.");
                })
                .finally(() => {
                    // reativa bot√µes de execu√ß√£o
                    document.querySelectorAll(".btn-run, .btn-run-global").forEach(b => b.disabled = false);
                    btn_refresh.disabled = false;
                    // esconde spinner
                    document.getElementById("spinnerOverlay").classList.add("hide");
                });
            }

            document.getElementById("btnRefresh").addEventListener("click", () => {
                carregarDados();
            });

            carregarDados();
        })();
    </script>
{% endblock extra_script %}
{% block extra_css %}
    <style>
        .command-output {
            font-family: monospace;
            white-space: pre-wrap;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 10px;
        }

        .command-output.stdout {
            background-color: #f5f5f5;
            color: #2e8b57; /* verde */
        }

        .command-output.stderr {
            background-color: #fff5f5;
            color: #b22222; /* vermelho */
        }

        .command-output strong {
            display: block;
            margin-bottom: 5px;
        }

        .spinner-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .spinner {
            border: 6px solid #f3f3f3;
            border-top: 6px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 0.9s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
{% endblock extra_css %}

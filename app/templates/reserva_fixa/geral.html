{% extends "base-fixed" %}
{% from "macros/form.html" import action_buttons %}
{% from "macros/navigation.html" import go_back %}
{% block title %}
    efetuar reserva
{% endblock title %}
{% block content %}
    {{ generate_reserva_head(locais, 'fixo', turno, semestre=semestre) }}
    <div class="btn-group">
        {{ go_back(contador_fixa) }}
        <a href="{{ url_for('default.home') }}" class="btn btn-default">
            <span class="glyphicon glyphicon-home"></span> Início
        </a>
    </div>
    <h3>
        <strong>Reserva Semestral:</strong> Dia {{ day|data }}
        <br>
        <strong>Semestre:</strong> {{ semestre.nome_semestre }} — <strong>Turno:</strong> {{ turno.nome_turno if turno else 'Livre' }}
    </h3>
    <p>
        <strong>Período:</strong> {{ semestre.data_inicio|data }} a {{ semestre.data_fim|data }}
        {% if turno %}
            <br>
            <strong>Horário:</strong> {{ turno.horario_inicio|hora }} às {{ turno.horario_fim|hora }}
        {% else %}
            <br>
            <strong>Horário:</strong> 00:00 às 23:59
        {% endif %}
        <br>
        <strong>Locais disponiveis:</strong> {{ locais|length }}
        <br>
        <strong>Horarios disponiveis:</strong> {{ aulas|length }}
    </p>
    <form class="form-group"
          role="form"
          action="{{ url_for('reservas_semanais.efetuar_reserva', id_semestre=semestre.id_semestre) }}"
          id="reserva"
          method="post">
        <div class="table-responsive tabela-wrapper">
            <table class="table table-bordered table-striped table-hover tabela-reserva">
                <thead>
                    <tr>
                        <th class="col-fixa">horario</th>
                        {% for local in locais %}
                            <th title="{{ local.descrição if local.descrição else '' }}">{{ local.nome_local.replace('laboratorio ', '') }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for aula_ativa, aula, semana in aulas %}
                        <tr>
                            <td class="col-fixa">{{ aula.horario_inicio|hora }} às {{ aula.horario_fim|hora }}, {{ semana.nome_semana }}</td>
                            {% for local in locais %}
                                <td data-aula="{{ aula_ativa.id_aula_ativa }}"
                                    data-local="{{ local.id_local }}"
                                    data-semestre="{{ semestre.inicio_semestre|data }}"
                                    data-id-reserva=""
                                    data-id-responsavel="">
                                    <input type="checkbox"
                                           class="form-check-input"
                                           name="reserva[{{ local.id_local }}, {{ aula_ativa.id_aula_ativa }}]">
                                </td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        <div class="form-group">
            <label for="finalidade_reserva">Destinação da Reserva:</label>
            <select id="finalidade_reserva"
                    class="form-control"
                    name="finalidade_reserva"
                    required>
                <option value="">Selecione a finalidade da reserva</option>
                {% for fr in finalidade_reserva %}<option value="{{ fr.value }}">{{ fr.value }}</option>{% endfor %}
            </select>
        </div>
        <div class="form-group">
            <label for="observacoes">Observações:</label>
            <textarea id="observacoes"
                      name="observacoes"
                      class="form-control"
                      placeholder="Insira observações relevantes (exemplo: softwares necessários)"
                      rows="6"
                      cols="60"></textarea>
        </div>
        <div class="form-group">
            <label for="descricao">Descrição:</label>
            <input type="text"
                   maxlength="100"
                   id="descricao"
                   name="descricao"
                   class="form-control"
                   placeholder="insira a descrição da reserva">
        </div>
        {% if user and user.perm|has_flag(ADMIN) %}
            <div class="form-group">
                <label for="responsavel">Responsavel:</label>
                <select id="responsavel" name="responsavel" class="form-control">
                    <option value="">Selecione o responsavel pela reserva</option>
                    {% for r in responsavel %}
                        <option value="{{ r.id_pessoa }}">({{ r.id_pessoa }}) {{ r.nome_pessoa }}</option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="responsavel_especial">Responsavel especial:</label>
                <select id="responsavel_especial"
                        name="responsavel_especial"
                        class="form-control">
                    <option value="">Selecione o responsavel especial pela reserva</option>
                    {% for r in responsavel_especial %}
                        <option value="{{ r.id_usuario_especial }}">({{ r.id_usuario_especial }}) {{ r.nome_usuario_especial }}</option>
                    {% endfor %}
                </select>
            </div>
        {% endif %}
        {{ action_buttons('inserir', show_voltar=False, label='') }}
    </form>
    {% if aulas_extras %}
        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">
                    <button class="btn btn-primary"
                            type="button"
                            data-toggle="collapse"
                            data-target="#collapseExtraAulas"
                            aria-expanded="false"
                            aria-controls="collapseExtraAulas">
                        <i class="glyphicon glyphicon-time"></i> Horários Extras
                        <small data-toggle="tooltip"
                               title="Horários válidos apenas durante parte do semestre">
                            <i class="glyphicon glyphicon-info-sign text-muted"></i>
                        </small>
                    </button>
                </h3>
            </div>
            <div class="panel-body collapse" id="collapseExtraAulas">
                <div class="table-responsive">
                    <table class="table table-bordered table-striped table-hover">
                        <thead>
                            <tr class="information">
                                <th>Dia da Semana</th>
                                <th>Horario</th>
                                <th>Intervalo de validade</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for info in aulas_extras %}
                                <tr>
                                    <td>{{ info[2].nome_semana }}</td>
                                    <td>{{ info[1].horario_inicio|hora }} - {{ info[1].horario_fim|hora }}</td>
                                    <td>{{ info[0].inicio_ativacao|data }} - {{ info[0].fim_ativacao|data }}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    {% endif %}
    {% if user and user.perm|has_flag(ADMIN) %}
        {% include "reserva_fixa/modal_reserva_editar.html" %}
        {% include "reserva_fixa/modal_reserva_excluir.html" %}
    {% endif %}
{% endblock content %}
{% block extra_script %}
    <script>{{ adjust_head_fix() }}</script>
    <script>
    document.addEventListener("DOMContentLoaded", function () {

        // =====================================================
        // CONFIGURAÇÕES INICIAIS
        // =====================================================

        const idResponsavelAtual = {{ user.pessoa.id_pessoa|tojson }};

        const baseUrl = {{ url_for(
            'api_reservas.get_reserva_indirect',
            tipo_reserva=0,
            dia=semestre.data_inicio,
            id_local=0,
            id_aula=0
        )|tojson }};

        function buildReservaUrl(localId, aulaId) {
            return baseUrl.replace('/0/0', `/${localId}/${aulaId}`);
        }

        // =====================================================
        // CONTROLE DO CAMPO DESCRIÇÃO
        // =====================================================

        function atualizarCampoDescricao() {
            const select = document.getElementById('finalidade_reserva');
            const descricao = document.getElementById('descricao');
            const wrapper = descricao.parentElement;

            if (select.value === 'Curso') {
                descricao.disabled = false;
                wrapper.style.display = 'block';
            } else {
                descricao.disabled = true;
                wrapper.style.display = 'none';
            }
        }

        document
            .getElementById('finalidade_reserva')
            .addEventListener('change', atualizarCampoDescricao);

        atualizarCampoDescricao();


        // =====================================================
        // BLOQUEIO POR HORÁRIO (RESPONSÁVEL)
        // =====================================================

        {% if not user or not user.perm|has_flag(ADMIN) %}
        function aplicarBloqueioPorHorario() {

            // limpa bloqueios antigos
            document.querySelectorAll('.tabela-reserva td[data-aula]').forEach(td => {
                td.classList.remove("td-conflito-horario");

                const checkbox = td.querySelector('input[type="checkbox"]');
                if (checkbox){
                    checkbox.disabled = false;
                    checkbox.checked = false;
                }
            });

            const horariosOcupados = new Set();

            document.querySelectorAll('td[data-id-responsavel]').forEach(td => {
                if (String(td.dataset.idResponsavel) === String(idResponsavelAtual)) {
                    horariosOcupados.add(td.dataset.aula);
                }
            });

            horariosOcupados.forEach(aulaId => {
                document.querySelectorAll(`td[data-aula="${aulaId}"]`)
                    .forEach(td => {

                        const checkbox = td.querySelector('input[type="checkbox"]');
                        if (checkbox){
                            checkbox.disabled = true;
                            checkbox.checked = false;
                        }

                        td.classList.add("td-conflito-horario");
                    });
            });
        }
        {% endif %}


        // =====================================================
        // ATUALIZAÇÃO DAS RESERVAS (AJAX)
        // =====================================================

        async function atualizarReservas() {

            const tds = document.querySelectorAll('.tabela-reserva td[data-aula]');

            for (const td of tds) {

                const localId = td.dataset.local;
                const aulaId = td.dataset.aula;
                const url = buildReservaUrl(localId, aulaId);

                try {
                    const response = await fetch(url);
                    if (!response.ok) throw new Error(response.status);

                    const data = await response.json();

                    if (data.reservado) {

                        td.classList.add('reservado');
                        td.classList.remove('livre');

                        td.dataset.idReserva = data.id_reserva;
                        td.dataset.idResponsavel = data.id_responsavel;

                        const checkbox = td.querySelector('input');
                        if (checkbox) checkbox.remove();

                        const firstName = data.responsavel?.split(' ')[0] || 'Reservado';
                        td.textContent = firstName;
                        td.title = data.responsavel || '';

                    } else {

                        td.classList.remove('reservado');
                        td.classList.add('livre');

                        td.dataset.idReserva = '';
                        td.dataset.idResponsavel = '';
                        td.title = '';

                        if (!td.querySelector('input')) {
                            td.innerHTML =
                                `<input type="checkbox" class="form-check-input" name="reserva[${localId},${aulaId}]">`;
                        }
                    }

                } catch (err) {
                    console.error(
                        `Erro ao verificar reserva (${localId}, ${aulaId}):`,
                        err
                    );
                }
            }

            // aplica bloqueio depois de atualizar tudo
            {% if not user or not user.perm|has_flag(ADMIN) %}
            aplicarBloqueioPorHorario();
            {% endif %}
        }

        atualizarReservas();
        setInterval(atualizarReservas, 60000);


        // =====================================================
        // BLOQUEIO POR AULA (checkbox manual)
        // =====================================================

        {% if not user or not user.perm|has_flag(ADMIN) %}
        document.addEventListener("change", function (e) {

            const checkbox = e.target.closest('td[data-aula] input[type="checkbox"]');
            if (!checkbox) return;

            const tdAtual = checkbox.closest("td");
            const aulaAtual = tdAtual.dataset.aula;
            const localAtual = tdAtual.dataset.local;

            document
                .querySelectorAll(`td[data-aula="${aulaAtual}"]`)
                .forEach(td => {

                    const input = td.querySelector('input[type="checkbox"]');
                    if (!input) return;

                    if (td.dataset.local !== localAtual) {
                        input.disabled = checkbox.checked;
                        td.classList.toggle("td-bloqueado", checkbox.checked);
                    }
                });
        });
        {% endif %}


        // =====================================================
        // ADMIN - MODAL RESERVA
        // =====================================================

        {% if user and user.perm|has_flag(ADMIN) %}

        document.addEventListener("click", function (e) {

            const td = e.target.closest("td.reservado");
            if (!td) return;

            const altPressed = e.altKey;
            const id = td.dataset.idReserva;

            const urlInfo = {{ url_for('api_reservas.get_reserva_info', tipo_reserva=0, id_reserva='0')|tojson }};
            const urlDelete = {{ url_for('api_reservas.delete_reserva', tipo_reserva=0, id_reserva='0')|tojson }};
            const urlEdit = {{ url_for('api_reservas.update_reserva', tipo_reserva=0, id_reserva='0')|tojson }};

            fetch(urlInfo.replace(/0$/, id))
                .then(r => r.json())
                .then(data => {
                    if (altPressed) {
                        DeleteData(data, urlDelete.replace(/0$/, id));
                    } else {
                        openReservaModal(data, urlEdit.replace(/0$/, id));
                    }
                })
                .catch(err =>
                    alert("Erro ao carregar reserva: " + err)
                );
        });

        {% endif %}

    });
    </script>
    {% if user and user.perm|has_flag(ADMIN) %}
        <script src="{{ url_for('static', filename='js/reserva_fixa_modal.js') }}"></script>
    {% endif %}
{% endblock extra_script %}

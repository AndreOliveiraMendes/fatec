{% extends "base-fluid" %}
{% from "macros/form.html" import action_buttons %}
{% from "macros/navigation.html" import go_back %}
{% block title %}
    efetuar reserva
{% endblock title %}
{% block content %}
    {{ generate_reserva_head(locais, 'fixo', turno, local, semestre=semestre) }}
    <div class="center-content">
        <div class="btn-group">
            {{ go_back(contador) }}
            <a href="{{ url_for("default.home") }}" class="btn btn-default">
                <span class="glyphicon glyphicon-home"></span> Início
            </a>
        </div>
        <h3>
            <strong>Reserva Semestral:</strong> Dia {{ day|data }}
            <br>
            <strong>Semestre:</strong> {{ semestre.nome_semestre }} — <strong>Turno:</strong> {{ turno.nome_turno if turno else 'Livre' }}
        </h3>
        <p>
            <strong>Período:</strong> {{ semestre.data_inicio|data }} a {{ semestre.data_fim|data }}
            {% if turno %}
                <br>
                <strong>Horário:</strong> {{ turno.horario_inicio|hora }} às {{ turno.horario_fim|hora }}
            {% else %}
                <br>
                <strong>Horário:</strong> 00:00 às 23:59
            {% endif %}
            <br>
            <strong>Horarios disponiveis:</strong> {{ head1|length }} <strong>Local:</strong> {{ local.nome_local }}
            <br>
            <strong>Especificação:</strong> {{ local.descrição }}
        </p>
        <form class="form-group"
              role="form"
              action="{{ url_for('reservas_semanais.efetuar_reserva', id_semestre=semestre.id_semestre) }}"
              id="reserva"
              method="post">
            <div class="table-responsive">
                <table class="table table-bordered table-striped table-hover tabela-reserva">
                    <thead>
                        <tr class="information">
                            <th>Dias da semana</th>
                            {% for aula in head1 %}<th>{{ aula.horario_inicio|hora }} - {{ aula.horario_fim|hora }}</th>{% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for semana in semanas %}
                            <tr>
                                <td>{{ semana['semana'].nome_semana }}</td>
                                {% for info in semana['infos'] %}
                                    {% if info %}
                                        {% set reserva = helper[(local.id_local, info[0].id_aula_ativa)] %}
                                        {% if reserva %}
                                            <td class="reservado"
                                                title="{{ reserva['title'] }}"
                                                {% if user and user.perm|has_flag(ADMIN) %}data-id-reserva="{{ reserva['id'] }}"{% endif %}>
                                                <span class="sr-only">Reservado</span>
                                                <!--
                                                <input type="checkbox" class="form-check-input checkbox-danger" title="{{ reserva['title'] }}" name="reserva[{{ local.id_local }},{{ info[0].id_aula_ativa }}]" disabled>
                                                -->
                                                {{ reserva['title'].strip().split()[0] }}
                                            </td>
                                        {% else %}
                                            <td>
                                                <input type="checkbox"
                                                       class="form-check-input"
                                                       name="reserva[{{ local.id_local }},{{ info[0].id_aula_ativa }}]">
                                            </td>
                                        {% endif %}
                                    {% else %}
                                        <td>-</td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="form-group">
                <label for="finalidade_reserva">Destinação da Reserva:</label>
                <select id="finalidade_reserva"
                        class="form-control"
                        name="finalidade_reserva"
                        required>
                    <option value="">Selecione a finalidade da reserva</option>
                    {% for fr in finalidade_reserva %}<option value="{{ fr.value }}">{{ fr.value }}</option>{% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="observacoes">Observações:</label>
                <textarea id="observacoes"
                          name="observacoes"
                          class="form-control"
                          placeholder="Insira observações relevantes (exemplo: softwares necessários)"
                          rows="6"
                          cols="60"></textarea>
            </div>
            <div class="form-group">
                <label for="descricao">Descrição:</label>
                <input type="text"
                       maxlength="100"
                       id="descricao"
                       name="descricao"
                       class="form-control"
                       placeholder="insira a descrição da reserva">
            </div>
            {% if user and user.perm|has_flag(ADMIN) %}
                <div class="form-group">
                    <label for="responsavel">Responsavel:</label>
                    <select id="responsavel" name="responsavel" class="form-control">
                        <option value="">Selecione o responsavel pela reserva</option>
                        {% for r in responsavel %}
                            <option value="{{ r.id_pessoa }}">({{ r.id_pessoa }}) {{ r.nome_pessoa }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="responsavel_especial">Responsavel especial:</label>
                    <select id="responsavel_especial"
                            name="responsavel_especial"
                            class="form-control">
                        <option value="">Selecione o responsavel especial pela reserva</option>
                        {% for r in responsavel_especial %}
                            <option value="{{ r.id_usuario_especial }}">({{ r.id_usuario_especial }}) {{ r.nome_usuario_especial }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}
            {{ action_buttons('inserir', show_voltar=False, label='') }}
        </form>
        {% if aulas_extras %}
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <button class="btn btn-primary"
                                type="button"
                                data-toggle="collapse"
                                data-target="#collapseExtraAulas"
                                aria-expanded="false"
                                aria-controls="collapseExtraAulas">
                            <i class="glyphicon glyphicon-time"></i> Horários Extras
                            <small data-toggle="tooltip"
                                   title="Horários válidos apenas durante parte do semestre">
                                <i class="glyphicon glyphicon-info-sign text-muted"></i>
                            </small>
                        </button>
                    </h3>
                </div>
                <div class="panel-body collapse" id="collapseExtraAulas">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover">
                            <thead>
                                <tr class="information">
                                    <th>Dia da Semana</th>
                                    <th>Horario</th>
                                    <th>Intervalo de validade</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for info in aulas_extras %}
                                    <tr>
                                        <td>{{ info[2].nome_semana }}</td>
                                        <td>{{ info[1].horario_inicio|hora }} - {{ info[1].horario_fim|hora }}</td>
                                        <td>{{ info[0].inicio_ativacao|data }} - {{ info[0].fim_ativacao|data }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
        {% if user and user.perm|has_flag(ADMIN) %}
            {% include "reserva_fixa/modal_reserva_editar.html" %}
            {% include "reserva_fixa/modal_reserva_excluir.html" %}
        {% endif %}
    </div>
{% endblock content %}
{% block extra_script %}
    <script>{{ adjust_head_fix() }}</script>
    <script>
    document.getElementById('finalidade_reserva').addEventListener('change', function() {
        var value = this.value;
        var descricao = document.getElementById('descricao');
        var descricaoWrapper = descricao.parentElement;

        if(value == 'Curso'){
            descricao.disabled = false;
            descricaoWrapper.style.display = 'block';
        } else {
            descricao.disabled = true;
            descricaoWrapper.style.display = 'none';
        }
    });

    window.addEventListener('load', function() {
        document.getElementById('finalidade_reserva').dispatchEvent(new Event('change'));
    });
    </script>
    {% if user and user.perm|has_flag(ADMIN) %}
        <script src="{{ url_for('static', filename='js/reserva_fixa_modal.js') }}"></script>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                document.addEventListener("click", function (e) {
                    const td = e.target.closest("td.reservado");
                    if (!td) return;

                    const altPressed = e.altKey;
                    const id = td.dataset.idReserva;
                    const url = {{ url_for('reservas_semanais.get_reserva_info', id_reserva='0')|tojson }};
                    const url_delete = {{ url_for('reservas_semanais.delete_reserva', id_reserva='0')|tojson }};

                    fetch(url.replace('0', id))
                        .then(r => r.json())
                        .then(data => {
                            if (altPressed) {
                                DeleteData(data, url_delete.replace('0', id));
                            } else {
                                openReservaModal(data);
                            }
                        })
                        .catch(err =>
                            alert("Erro ao carregar reserva devido a: " + err)
                        );
                });
            });
        </script>
    {% endif %}
{% endblock extra_script %}

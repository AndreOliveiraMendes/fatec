{% extends "base-fluid" %}
{% from "macros/form.html" import action_buttons %}
{% from "macros/navigation.html" import go_back %}
{% block title %}
    efetuar reserva
{% endblock title %}
{% block content %}
    {{ generate_reserva_head(locais, 'fixo', turno, local, semestre=semestre) }}
    <div class="center-content">
        <div class="btn-group">
            {{ go_back(contador) }}
            <a href="{{ url_for("default.home") }}" class="btn btn-default">
                <span class="glyphicon glyphicon-home"></span> Início
            </a>
        </div>
        <h3>
            <strong>Reserva Semestral:</strong> Dia {{ day|data }}
            <br>
            <strong>Semestre:</strong> {{ semestre.nome_semestre }} — <strong>Turno:</strong> {{ turno.nome_turno if turno else 'Livre' }}
        </h3>
        <p>
            <strong>Período:</strong> {{ semestre.data_inicio|data }} a {{ semestre.data_fim|data }}
            {% if turno %}
                <br>
                <strong>Horário:</strong> {{ turno.horario_inicio|hora }} às {{ turno.horario_fim|hora }}
            {% else %}
                <br>
                <strong>Horário:</strong> 00:00 às 23:59
            {% endif %}
            <br>
            <strong>Horarios disponiveis:</strong> {{ first_col|length }} <strong>Local:</strong> {{ local.nome_local }}
            <br>
            <strong>Especificação:</strong> {{ local.descrição }}
        </p>
        <form class="form-group"
              role="form"
              action="{{ url_for('reservas_semanais.efetuar_reserva', id_semestre=semestre.id_semestre) }}"
              id="reserva"
              method="post">
            <div class="table-responsive tabela-wrapper">
                <table class="table table-bordered table-striped table-hover tabela-reserva">
                    <thead>
                        <tr>
                            <th class="col-fixa">horario</th>
                            {% for h in head %}<th>{{ h.nome_semana }}</th>{% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for fc in first_col %}
                            <tr>
                                <td class="col-fixa">{{ fc.horario_inicio|hora }} - {{ fc.horario_fim|hora }}</td>
                                {% for h in head %}
                                    {% set aula_id = row.get((fc.id_aula, h.id_semana)) %}
                                    <td class=" {% if aula_id %} livre {% else %} indisponivel {% endif %} "
                                        {% if aula_id %} data-aula="{{ aula_id }}" data-local="{{ local.id_local }}" data-semestre="{{ semestre.inicio_semestre|data }}" {% endif %}>
                                        {% if aula_id %}
                                            <input type="checkbox"
                                                   class="form-check-input"
                                                   name="reserva[{{ local.id_local }}, {{ aula_id }}]">
                                        {% endif %}
                                    </td>
                                {% endfor %}
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="form-group">
                <label for="finalidade_reserva">Destinação da Reserva:</label>
                <select id="finalidade_reserva"
                        class="form-control"
                        name="finalidade_reserva"
                        required>
                    <option value="">Selecione a finalidade da reserva</option>
                    {% for fr in finalidade_reserva %}<option value="{{ fr.value }}">{{ fr.value }}</option>{% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="observacoes">Observações:</label>
                <textarea id="observacoes"
                          name="observacoes"
                          class="form-control"
                          placeholder="Insira observações relevantes (exemplo: softwares necessários)"
                          rows="6"
                          cols="60"></textarea>
            </div>
            <div class="form-group">
                <label for="descricao">Descrição:</label>
                <input type="text"
                       maxlength="100"
                       id="descricao"
                       name="descricao"
                       class="form-control"
                       placeholder="insira a descrição da reserva">
            </div>
            {% if user and user.perm|has_flag(ADMIN) %}
                <div class="form-group">
                    <label for="responsavel">Responsavel:</label>
                    <select id="responsavel" name="responsavel" class="form-control">
                        <option value="">Selecione o responsavel pela reserva</option>
                        {% for r in responsavel %}
                            <option value="{{ r.id_pessoa }}">({{ r.id_pessoa }}) {{ r.nome_pessoa }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="form-group">
                    <label for="responsavel_especial">Responsavel especial:</label>
                    <select id="responsavel_especial"
                            name="responsavel_especial"
                            class="form-control">
                        <option value="">Selecione o responsavel especial pela reserva</option>
                        {% for r in responsavel_especial %}
                            <option value="{{ r.id_usuario_especial }}">({{ r.id_usuario_especial }}) {{ r.nome_usuario_especial }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}
            {{ action_buttons('inserir', show_voltar=False, label='') }}
        </form>
        {% if aulas_extras %}
            <div class="panel panel-info">
                <div class="panel-heading">
                    <h3 class="panel-title">
                        <button class="btn btn-primary"
                                type="button"
                                data-toggle="collapse"
                                data-target="#collapseExtraAulas"
                                aria-expanded="false"
                                aria-controls="collapseExtraAulas">
                            <i class="glyphicon glyphicon-time"></i> Horários Extras
                            <small data-toggle="tooltip"
                                   title="Horários válidos apenas durante parte do semestre">
                                <i class="glyphicon glyphicon-info-sign text-muted"></i>
                            </small>
                        </button>
                    </h3>
                </div>
                <div class="panel-body collapse" id="collapseExtraAulas">
                    <div class="table-responsive">
                        <table class="table table-bordered table-striped table-hover">
                            <thead>
                                <tr class="information">
                                    <th>Dia da Semana</th>
                                    <th>Horario</th>
                                    <th>Intervalo de validade</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for info in aulas_extras %}
                                    <tr>
                                        <td>{{ info[2].nome_semana }}</td>
                                        <td>{{ info[1].horario_inicio|hora }} - {{ info[1].horario_fim|hora }}</td>
                                        <td>{{ info[0].inicio_ativacao|data }} - {{ info[0].fim_ativacao|data }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        {% endif %}
        {% if user and user.perm|has_flag(ADMIN) %}
            {% include "reserva_fixa/modal_reserva_editar.html" %}
            {% include "reserva_fixa/modal_reserva_excluir.html" %}
        {% endif %}
    </div>
{% endblock content %}
{% block extra_script %}
    <script>{{ adjust_head_fix() }}</script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            const idResponsavelAtual = {{ user.pessoa.id_pessoa|tojson }};

            /* =========================
            FINALIDADE → DESCRIÇÃO
            ========================== */
            const finalidade = document.getElementById('finalidade_reserva');
            const descricao = document.getElementById('descricao');

            function toggleDescricao(){
                if(!finalidade || !descricao) return;

                const wrapper = descricao.parentElement;
                const ativo = finalidade.value === 'Curso';

                descricao.disabled = !ativo;
                wrapper.style.display = ativo ? 'block' : 'none';
            }

            if(finalidade){
                finalidade.addEventListener('change', toggleDescricao);
                toggleDescricao(); // estado inicial
            }


            /* =========================
            TABELA RESERVAS AUTOLOAD
            ========================== */
            const baseUrl = {{ url_for(
                'api_reservas.get_reserva_indirect',
                tipo_reserva=0,
                dia=semestre.data_inicio,
                id_local=0,
                id_aula=0
            )|tojson }};

            const baseConflictUrl = {{ url_for(
                'api_reservas.check_conflito_reserva',
                tipo_reserva=0,
                dia=semestre.data_inicio,
                id_aula=0,
                id_responsavel=0
            )|tojson }};

            const buildReservaUrl = (localId, aulaId) =>
                baseUrl.replace('/0/0', `/${localId}/${aulaId}`);

            const buildConflictUrl = (aulaId, responsavelId) =>
                baseConflictUrl.replace('/0/0', `/${aulaId}/${responsavelId}`);

            async function atualizarReservas(){
                const cells = document.querySelectorAll('.tabela-reserva td[data-aula]');

                for(const td of cells){
                    const localId = td.dataset.local;
                    const aulaId = td.dataset.aula;

                    try{
                        const res = await fetch(buildReservaUrl(localId, aulaId));
                        if(!res.ok) throw new Error(res.status);

                        const data = await res.json();

                        if(data.reservado){
                            td.classList.add('reservado');
                            td.classList.remove('livre');
                            td.classList.remove('td-conflito-horario')
                            td.dataset.idReserva = data.id_reserva;

                            td.querySelector('input')?.remove();

                            const firstName = data.responsavel?.split(' ')[0] || 'Reservado';
                            td.textContent = firstName;
                            td.title = data.responsavel || '';
                        } else {
                            td.classList.remove('reservado');
                            td.classList.add('livre');
                            td.dataset.idReserva = '';

                            if(!td.querySelector('input')){
                                td.innerHTML =
                                    `<input type="checkbox" class="form-check-input" name="reserva[${localId},${aulaId}]">`;
                            }

                            {% if not user or not user.perm|has_flag(ADMIN) %}
                            const check = await fetch(buildConflictUrl(aulaId, idResponsavelAtual));
                            if(!check.ok) throw new Error(check.status);

                            const data = await check.json();

                            if(data.conflict){
                                td.classList.add('td-conflito-horario');

                                const checkbox = td.querySelector('input[type="checkbox"]');
                                if (checkbox){
                                    checkbox.disabled = true;
                                    checkbox.checked = false;

                                    const labs = data.labs.map(l => l.nome).join(", ");
                                    td.title = `Conflito de horário: ${labs}`;
                                }
                            } else {
                                td.classList.remove('td-conflito-horario');
                                td.title = '';
                            }
                            {% endif %}
                        }

                    }catch(err){
                        console.error(`Erro reserva ${localId}/${aulaId}:`, err);
                    }
                }
            }

            atualizarReservas();
            setInterval(atualizarReservas, 60000);


            /* =========================
            CLICK EM RESERVA (ADMIN)
            ========================== */
            {% if user and user.perm|has_flag(ADMIN) %}
            document.addEventListener("click", async e => {

                const td = e.target.closest("td.reservado");
                if(!td) return;

                const id = td.dataset.idReserva;
                if(!id) return;

                const altPressed = e.altKey;

                const urlInfo = {{ url_for('api_reservas.get_reserva_info', tipo_reserva=0, id_reserva='0')|tojson }}.replace(/0$/, id);
                const urlDelete = {{ url_for('api_reservas.delete_reserva', tipo_reserva=0, id_reserva='0')|tojson }}.replace(/0$/, id);
                const urlEdit = {{ url_for('api_reservas.update_reserva', tipo_reserva=0, id_reserva='0')|tojson }}.replace(/0$/, id);

                try{
                    const res = await fetch(urlInfo);
                    const data = await res.json();

                    if(altPressed){
                        DeleteData(data, urlDelete);
                    } else {
                        openReservaModal(data, urlEdit);
                    }
                }catch(err){
                    alert("Erro ao carregar reserva: " + err);
                }

            });
            {% endif %}

        });
    </script>
    {% if user and user.perm|has_flag(ADMIN) %}
        <script src="{{ url_for('static', filename='js/reserva_fixa_modal.js') }}"></script>
    {% endif %}
{% endblock extra_script %}
